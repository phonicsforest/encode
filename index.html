<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Santa Game test</title>
<style>
  html, body { height:100%; margin:0; background:#bdd7ee; overflow:hidden; }

.frame{
  /* height:100vh; aspect-ratio:1280/740; width:auto;  â† åˆª */
  width:100svw;             /* æ”¯æ´ iOS/Android 16+ çš„å°è¦–çª—å–®ä½ */
  height:100dvh;            /* çœŸå¯¦å¯è¦–é«˜ï¼Œé¿å…ç¶²å€åˆ—å½±éŸ¿ */
  max-width:100vw;          /* è€ç€è¦½å™¨ fallback */
  max-height:100vh;
  margin:0 auto;
  position:relative;
  overflow:hidden;          /* é˜²æ­¢å‡ºç¾æ²è»¸ */
  background:#bdd7ee;
  min-height:360px;
}
  #scaleRoot{
    position:absolute;
    width:1280px;
    height:740px;
    left:0; top:0;
    transform-origin: top left;
    transform: scale(1);
    min-width:640px; min-height:370px;
  }

  .stage { position:relative; width:100%; height:100%; overflow:hidden; }
  .sprite { position:absolute; user-select:none; -webkit-user-drag:none; pointer-events:none; height:auto; }

  /* åŸºæº–å°ºå¯¸ */
  #flue  { height:111px; z-index:20; bottom:0; }
  #santa { height:300px; z-index:160; bottom:0; }
  #treeLeft   { height:666px; z-index:3; bottom:0; }
  #treeBehind { height:740px; z-index:2; bottom:0; }
  #treeFront  { height:296px; z-index:1; bottom:0; }
#bell {
  height:133px;
  z-index:200;              /* æå‡åˆ°æœ€å‰ */
  transform:rotate(-30deg);
  pointer-events:auto;
  transition:transform .15s ease, filter .2s ease;
  bottom:40px;
}
  #bell:hover { transform:rotate(-20deg) scale(1.08); filter:brightness(1.15); }
  #bell.bell-press { transform:rotate(-20deg) scale(1.05); filter:brightness(1.1); }
  #bell[disabled]{ pointer-events:none; filter:none; opacity:1; }

  #hill{
    position:absolute;
    bottom:0;
    left:50%;
    transform:translateX(20%) scale(1.5);
    transform-origin:bottom center;
    z-index:0;
  }

  /* æ¨¹é£¾ç‰© */
  .tree1-bauble, .tree2-bauble { position:absolute; z-index:4; aspect-ratio:1/1; cursor:pointer; transform: scale(1.5); transition: transform .18s ease; }
  .tree1-bauble:hover, .tree2-bauble:hover { transform: scale(1.6); }
  .bauble-base{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; display:block; z-index:1; }
  .letter-layer{ position:absolute; z-index:2; }
  .baubleLetter, .tree2-letter {
    position:absolute; left:50%; bottom:12%; transform:translateX(-50%);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang HK";
    text-shadow:0 1px 2px rgba(0,0,0,.35);
  }
  .baubleLetter { color:#fff; font-weight:500; }
  .tree2-letter { color:#d01010; font-weight:700; }

  .tree1-bauble.selected [data-role="base"]{ content:url('graphic/redbauble_glow.png'); }
  .tree2-bauble.selected [data-role="base"].wb-default{ content:url('graphic/whitebauble_glow.png'); }
  /* ç‰¹è£½ç™½çƒ glow åœ¨ JS æœƒç›´æ¥æ› src */

  /* ğŸˆ Balloon group */
.balloon-group{ position:absolute; z-index:19; width:200px; aspect-ratio:1/1; pointer-events:none; }
  .balloon-group .balloon{ position:absolute; width:60%; height:auto; }
  #redBalloon{    left:20%; top:0%;   z-index:1; }
  #yellowBalloon{ left:50%; top:10%;  z-index:2; }
  #giftBox{ left:32%; top:90%; pointer-events:auto; cursor:pointer; position:absolute; width:58%; z-index:3; transition: transform .25s ease; }

  @keyframes balloonFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)}}
  #redBalloon, #yellowBalloon, #giftBox { animation: balloonFloat 2.8s ease-in-out infinite; }

  #balloonGroup.enterRight { animation: groupInRight 1.6s ease-out forwards; }
  #balloonGroup.leaveLeft  { animation: groupOutLeft 2s ease-out forwards; }
  @keyframes groupInRight  { from { transform: translateX(60vw); } to { transform: translateX(0); } }
  @keyframes groupOutLeft  { from { transform: translateX(0); }    to { transform: translateX(-110vw); } }
  .balloon-burst-fade { animation: burstFade .25s linear forwards; }
  @keyframes burstFade { from{opacity:1} to{opacity:0} }
  .box-drop { animation: boxFall 2s cubic-bezier(.2,.8,.2,1) forwards; }
  @keyframes boxFall { 0%{transform:translateY(0);opacity:1} 85%{transform:translateY(555px);opacity:1} 100%{transform:translateY(592px);opacity:0} }

  /* Set é¸å–®ï¼ˆæ”¾åœ¨ scaleRoot å…§ï¼›è·Ÿ flue/balloon åŒä¸­å¿ƒç·šï¼‰ */
  #setPicker {
    position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
    background: rgba(255,255,255,.85); border-radius: 8px; padding: 6px 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 100000; font-size: 14px; display:flex; gap:10px; align-items:center;
  }
  #setPicker select{
    padding: 6px 12px;
    border: 2px solid #2b2b2b;
    border-radius: 10px;
    background: #fff;
    color: #1f1f1f;
    appearance: none;
  }
  #setPicker select:focus{ outline: 2px solid rgba(200,16,46,.35); outline-offset: 2px; }
  #setGoBtn {
    background:#c8102e; color:white; border:none; border-radius:50%;
    width:38px; height:38px; font-weight:bold; cursor:pointer;
    transition:transform .2s ease, background .3s ease;
  }
  #setGoBtn:hover { background:#e01e37; transform:scale(1.1); }

  /* Finish */
  #finishPanel{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:transparent; z-index:9000; pointer-events:none; }
#finishCard{
  position:absolute;
  top:50%;
  /* é—œéµï¼šå·¦é‚Šä½ç½®ç”¨ JS è¨­å®šï¼ˆflue ä¸­å¿ƒï¼‰ï¼Œé€™è£¡åªè² è²¬ç½®ä¸­ï¼‹æ”¾å¤§ */
  transform: translate(-50%, -50%) scale(1.4);  /* â† æ”¾å¤§ 40% */
  transform-origin: center;
  text-align:center;
}
#finishList{
  font-size:20px;
  line-height:1.6;
  white-space:pre;        /* é€è¡Œé¡¯ç¤º */
  text-align:center;      /* æ–‡å­—ç½®ä¸­ */
  margin-bottom:10px;
}
#finishCard h2{
  margin:.2em 0 .3em;
  font-size:30px;
  color:#8d0f0f;          /* æ·±ç´… */
}
  .tree-overlay{ position:absolute; z-index:4; pointer-events:auto; }
  .tree-overlay .tree1-bauble, .tree-overlay .tree2-bauble{ pointer-events:auto; }

  /* Snow */
  .snowWrap{ position:absolute; top:-40px; pointer-events:none; z-index:20; animation: snow-sway 7s ease-in-out infinite alternate; }
  .snow{ position:absolute; top:0; left:0; will-change: transform; animation: snow-fall 10s linear forwards; }
  @keyframes snow-fall { from { transform: translateY(-50px); opacity: 0.95; } to { transform: translateY(800px); opacity: 0.95; } }
  @keyframes snow-sway { from { transform: translateX(0); } to { transform: translateX(var(--amp, 24px)); } }
</style>
</head>
<body>

  <div class="frame" id="frame">
    <div id="scaleRoot">
      <div id="setPicker">
 <select id="setPickerSelect">
<option value="">-----</option>
<option value="0">SET 1 -- a</option>
<option value="1">SET 2 -- a i</option>
<option value="2">SET 3 -- a i e</option>
<option value="3">SET 4 -- a i e o</option>
<option value="4">SET 5 -- a i e o u</option>
<option value="5">SET 6 -- a e</option>
<option value="6">SET 7 -- ic A</option>
<option value="7">SET 8 -- ic A E</option>
<option value="8">SET 9 -- ic A E I</option>
<option value="9">SET 10 -- ic A E I O</option>
<option value="10">SET 11 -- E i</option>
<option value="11">SET 12 -- E U</option>
<option value="12">SET 13 -- U i_e ing</option>
<option value="13">SET 14 -- U i_e ing ue</option>
<option value="14">SET 15 -- U i_e ing ue or</option>
<option value="15">SET 16 -- ir or oi</option>
<option value="16">SET 17 -- ir or oi ou</option>
<option value="17">SET 18 -- ir or oi ou ue</option>
        </select>
        <button id="setGoBtn">Go</button>
      </div>

      <div class="stage" id="stage">
        <img id="hill"      class="sprite" src="graphic/hill.png"   alt="hill" />
        <img id="flue"      class="sprite" src="graphic/flue.png"   alt="flue" />
        <img id="santa"     class="sprite" src="graphic/santa.png"  alt="santa" />
        <img id="bell"      class="sprite" src="graphic/bell.png"   alt="bell" />
        <img id="treeLeft"  class="sprite" src="graphic/tree.png"   alt="tree left" />
        <img id="treeBehind"class="sprite" src="graphic/tree.png"   alt="tree right" />
      </div>

      <div id="finishPanel"><div id="finishCard"><h2>Finish!</h2><div id="finishList"></div></div></div>
    </div>
  </div>

<script>

/* ================= å¸¸é‡èˆ‡è³‡æ–™ ================= */
const AUDIO_PATH = 'audio/';
const SANTA_HAPPY = 'graphic/santa_happy.png';
const SANTA_SAD   = 'graphic/santa_sad.png';
const SANTA_NORM  = 'graphic/santa.png';

/* Set å®šç¾© */
const SETS = [
  { reds: ['b','k','d','f','g','h','n'], whites: ['a'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['a','i'] },
  { reds: ['b','k','d','f','g','h','n'], whites: ['a','i','e'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['a','i','e','o'] },
  { reds: ['b','k','d','f','g','h','n'], whites: ['a','i','e','o','u'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['a','e'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['ic','A'] },
  { reds: ['b','k','d','f','g','h','n'], whites: ['ic','A','E'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['ic','A','E','I'] },
  { reds: ['b','k','d','f','g','h','n'], whites: ['ic','A','E','I','O'] },
  { reds: ['b','k','d','f','g','h','n'], whites: ['E','i'] },
  { reds: ['b','k','d','f','g','h','n'], whites: ['E','U'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['U','ite','eng'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['U','ite','eng','ue'] },
  { reds: ['b','k','d','f','g','h','n'], whites: ['U','ite','eng','ue','or'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['ir','or','oi']},
  { reds: ['b','k','d','f','g','h','n'], whites: ['ir','or','oi','ou'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['ir','or','oi','ou','ue']},
]




/* å·¥å…· */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const rect = el => el.getBoundingClientRect();

/* ç‹€æ…‹ */
let currentSetIndex = -1;
let queue = [];
let basePairs = [];
let qPos = -1;
let selectedRed = null, selectedWhite = null;
let bellLocked = true;
const attemptsMap = new Map();

/* ä½ç½®åç§»ï¼ˆé‚„åŸä½ ä¹‹å‰å–œæ­¡çš„ç›¸å°ä½ï¼‰ */
const OFF = {
  flue:     { x: -50,  y: 0 },   // flue å‘å·¦ 50px
  set:      { x: -50,  y: 0 },   // Set è·Ÿ flue åŒä¸€ä¸­å¿ƒç·š
  leftTree: { x: 0,    y: 0 },
  rightTree:{ x: -40,  y: 0 },   // å³æ¨¹é è¿‘ Santa
  santa:    { x: -20,    y: 0 },   // ä»¥ flue å³é‚Šç‚ºåŸºæº–ã€Œè²¼ä½ã€â†’ 0
  bell:     { x: 0,    y: 0 }    // ä¾ Santa ä¸­ç·š
};

/* bauble spotsï¼ˆç™¾åˆ†æ¯”ï¼‰ */
const SPOTS_LEFT  = [
  {x:.50, y:.08}, {x:.68, y:.28}, {x:.34, y:.38},
  {x:.70, y:.50}, {x:.20, y:.60}, {x:.90, y:.70}, {x:.50, y:.76}
];
const SPOTS_RIGHT = [
  {x:.49, y:.18}, {x:.70, y:.36}, {x:.31, y:.40},
  {x:.62, y:.57}, {x:.83, y:.75}, {x:.88, y:.66}, {x:.52, y:.72}
];

/* ç™½çƒåœ–ç‰‡ tokenï¼ˆæœ‰ç¨ç«‹è²¼åœ–æª”ï¼‰ */
const WHITE_IMG_TOKENS = new Set(['ic','ite','eng','ue','or','ir','ou','oi']);

/* ç”¢ç”Ÿç™½çƒåº•åœ– srcï¼ˆä¸€èˆ¬/Glowï¼‰ */
function whiteSrc(token, glow=false){
  const t = String(token||'').trim();
  if (WHITE_IMG_TOKENS.has(t.toLowerCase())) {
    return glow ? `graphic/whitebauble_glow${t}.png` : `graphic/whitebauble${t}.png`;
  }
  return glow ? 'graphic/whitebauble_glow.png' : 'graphic/whitebauble.png';
}

function positionFinish(){
  const panel = document.getElementById('finishPanel');
  if (!panel || panel.style.display === 'none') return;

  const card = document.getElementById('finishCard');
  const st = rect(document.getElementById('stage'));
  const fl = rect(document.getElementById('flue'));

  // ä»¥ stage ä½œåº§æ¨™ç³»ï¼Œå– flue çš„æ­£ä¸­
  const flCenterX = (fl.left - st.left) + fl.width/2 +45;

  card.style.left = flCenterX + 'px';
}

/* ========== ç‰ˆé¢å®šä½ï¼ˆåªè¨ˆ 1280Ã—740 åŸå°ºå¯¸ï¼‰ ========== */
function layout(){
  const stage = $('#stage'), flue = $('#flue'), santa = $('#santa'), bell = $('#bell');
  const treeLeft = $('#treeLeft'), treeRight = $('#treeBehind');
  const hill = $('#hill');
  const st = rect(stage);

  // hill ç½®ä¸­
  if (hill){
    const hb = rect(hill);
    hill.style.left = (st.width/2 - hb.width/2) + 'px';
    hill.style.bottom = '0px';
  }

  // flue ç½®ä¸­ + åç§»
  const flBox = rect(flue);
  const flueLeft = (st.width/2 - flBox.width/2) + OFF.flue.x;
  flue.style.left   = flueLeft + 'px';
  flue.style.bottom = (0 + OFF.flue.y) + 'px';
  const fl = rect(flue);

  // Santa è²¼ flue å³é‚Š
  santa.style.left   = (fl.right - st.left + OFF.santa.x) + 'px';
  santa.style.bottom = (0 + OFF.santa.y) + 'px';

  // ç®— Santa ä¸­ç·šï¼ˆä¹‹å¾Œå…ˆå¯ä»¥ç”¨ï¼‰
  const sa = rect(santa);
  const saMid = (sa.left + sa.right)/2 - st.left;

  // Bell ä¾ Santa ä¸­ç·š
  bell.style.left   = (saMid + 120 + OFF.bell.x) + 'px';
  bell.style.bottom = (40 + OFF.bell.y) + 'px';

  // å·¦æ¨¹ï¼šä¾ flue å·¦é‚Š
  const tl = rect(treeLeft);
  const baseLeftL = fl.left - st.left - tl.width;
  treeLeft.style.left   = (baseLeftL + OFF.leftTree.x) + 'px';
  treeLeft.style.bottom = (0 + OFF.leftTree.y) + 'px';

  // å³æ¨¹ï¼šä¾ Santa ä¸­ç·šï¼ˆçª„è¢å¹•å†å·¦ç§»å°‘å°‘ï¼‰
  const scaleNow = window._stageScale || 1;
  const extraRightTreeShift = (scaleNow < 0.6) ? -30 : 0;
  treeRight.style.left   = (saMid + OFF.rightTree.x + extraRightTreeShift) + 'px';
  treeRight.style.bottom = (0 + OFF.rightTree.y) + 'px';

  // Set é¸å–®èˆ‡ flue åŒä¸­å¿ƒç·š
  const picker = $('#setPicker');
  if (picker){
    picker.style.left = `calc(50% + ${OFF.set.x}px)`;
    picker.style.top  = (10 + OFF.set.y) + 'px';
    picker.style.transform = 'translateX(-50%)';
  }

  // å»º baubles
  if (currentSetIndex >= 0){
    const set = SETS[currentSetIndex];
    buildTreeBaubles('#treeLeft',   set.reds,   SPOTS_LEFT,  false);
    buildTreeBaubles('#treeBehind', set.whites, SPOTS_RIGHT, true);
  }

  positionBalloonGroup();
  positionFinish();
}

/* åœ¨æ¨¹ä¸Šå»ºç«‹ overlay */
function ensureTreeOverlay(treeEl, id){
  let ov = document.getElementById(id);
  if (!ov){
    ov = document.createElement('div');
    ov.id = id;
    ov.className = 'tree-overlay';
    ov.style.position = 'absolute';
    ov.style.pointerEvents = 'auto';
    $('#scaleRoot').appendChild(ov);
  }
  ov.style.left   = treeEl.offsetLeft + 'px';
  ov.style.top    = treeEl.offsetTop  + 'px';
  ov.style.width  = treeEl.clientWidth  + 'px';
  ov.style.height = treeEl.clientHeight + 'px';
ov.style.zIndex = 6;
  return ov;
}

/* å»ºç«‹å·¦/å³æ¨¹ baublesï¼ˆå³æ¨¹æ”¯æ´ç‰¹è£½ç™½çƒåº•åœ–ï¼‰ */
function buildTreeBaubles(treeSelector, letters, spots, isRight){
  const tree = document.querySelector(treeSelector);
  if (!tree) return;

  const overlay = ensureTreeOverlay(tree, isRight ? 'ovRight' : 'ovLeft');
  overlay.querySelectorAll('.tree1-bauble, .tree2-bauble').forEach(n=>n.remove());

  const w = overlay.clientWidth;
  const size = Math.max(28, Math.min(w * 0.22 * 1.3, 120 * 1.3));
  const L = Math.min((letters || []).length, spots.length);

  for (let i=0;i<L;i++){
    const rawToken = letters[i];
    const tokenLower = String(rawToken).trim().toLowerCase();
    const pos = spots[i];

    const wrap = document.createElement('div');
    wrap.className = isRight ? 'tree2-bauble' : 'tree1-bauble';
    wrap.style.position = 'absolute';
    wrap.style.width  = size+'px';
    wrap.style.height = size+'px';
    wrap.style.left = `calc(${pos.x*100}% - ${size/2}px)`;
    wrap.style.top  = `calc(${pos.y*100}% - ${size/2}px)`;
    wrap.dataset.letter = isRight ? tokenLower : tokenLower;
    wrap.style.pointerEvents = 'auto';

    // åº•çƒ
    const baseImg = document.createElement('img');
    baseImg.dataset.role = 'base';
    baseImg.className = 'bauble-base' + (isRight && !WHITE_IMG_TOKENS.has(tokenLower) ? ' wb-default' : '');
    baseImg.alt = isRight ? 'white bauble' : 'red bauble';
    baseImg.src = isRight ? whiteSrc(rawToken, false) : 'graphic/redbauble.png';
    wrap.appendChild(baseImg);

    // æ–‡å­—å±¤ï¼ˆç´…çƒé¡¯å­—ï¼ä¸€èˆ¬ç™½çƒé¡¯å­—ï¼›ç‰¹è£½ç™½çƒå·²ç”¨è²¼åœ–ï¼Œä¸åŠ å­—ï¼‰
    if (!isRight){
      const span = document.createElement('span');
      span.className = 'baubleLetter letter-layer';
      span.textContent = rawToken;
      span.style.fontSize = (size * 0.52) + 'px';
      span.style.left='50%'; span.style.bottom='12%'; span.style.transform='translateX(-50%)';
      wrap.appendChild(span);
} else if (!WHITE_IMG_TOKENS.has(tokenLower)) {
      const span = document.createElement('span');
      span.className = 'tree2-letter letter-layer';
      span.textContent = rawToken;
      span.style.fontSize = (size * 0.52) + 'px';
      span.style.left='50%'; span.style.bottom='12%'; span.style.transform='translateX(-50%)';
      wrap.appendChild(span);
    }

    overlay.appendChild(wrap);

    // é»æ“Šï¼ˆå³æ¨¹ï¼šå…ˆé è½ï¼Œç„¶å¾Œè™•ç†é¸å–ï¼›å·¦æ¨¹ï¼šåªè™•ç†é¸å–ï¼‰
    wrap.addEventListener('click', ()=>{
      // å³æ¨¹ç™½çƒï¼šé»æ“Šé è½ï¼ˆä¸å— bellLocked é™åˆ¶ï¼‰
      if (isRight){
        previewWhiteAudio(rawToken);
      }

      // é¸å–åªåœ¨æœªé–é˜æ™‚æœ‰æ•ˆ
      if (bellLocked) return;

      overlay.querySelectorAll(isRight ? '.tree2-bauble' : '.tree1-bauble').forEach(n=>{
        n.classList.remove('selected');
        const base = n.querySelector('[data-role="base"]');
        if (base){
          if (isRight){
            base.src = whiteSrc(n.dataset.letter, false);
          }else{
            base.src = 'graphic/redbauble.png';
          }
        }
      });

      wrap.classList.add('selected');
      const base = wrap.querySelector('[data-role="base"]');
      if (base){
        if (isRight){
          base.src = whiteSrc(wrap.dataset.letter, true);
        }else{
          base.src = 'graphic/redbauble_glow.png';
        }
      }

      if (isRight) selectedWhite = wrap; else selectedRed = wrap;
    });
  }
}

/* é è½ç™½çƒéŸ³æª”ï¼ˆAEIOU/aeiou éœéŸ³ï¼Œä¸æ’­ï¼›ç‰¹å®šçµ„åˆéŸ³é‡30%ï¼‰ */
function previewWhiteAudio(rawToken){
  const t = String(rawToken).trim();

  // AEIOU / aeiou â†’ ä¸æ’­æ”¾é è½
  if (/^[AEIOU]$/.test(t) || /^[aeiou]$/.test(t)) {
    return;
  }

  const key = t.toLowerCase();
  const src = `${AUDIO_PATH}${key}.mp3`;

  try {
    const audio = new Audio(src);

    // ä»¥ä¸‹çµ„åˆç´°è² 30%
    const quietTokens = ['ic', 'ite', 'eng', 'ue', 'ir', 'oi', 'or', 'ou'];
    if (quietTokens.includes(key)) {
      audio.volume = 0.6;
    }

    audio.play();
  } catch (e) {}
}

/* ========= ç­‰æ¯”ç¸®æ”¾ ========= */
function applyScale(){
  const frame = document.getElementById('frame');
  const root  = document.getElementById('scaleRoot');

  // å–æœ€æº–çš„å¯è¦–å€å°ºå¯¸ï¼ˆæœ‰ visualViewport å„ªå…ˆç”¨ï¼‰
  const vw = window.visualViewport ? window.visualViewport.width  : frame.clientWidth;
  const vh = window.visualViewport ? window.visualViewport.height : frame.clientHeight;

  const designW = 1280, designH = 740;

  // ç­‰æ¯”ç¸®æ”¾ï¼šä»¥å¯¬é«˜éƒ½èƒ½æ”¾ä¸‹ç‚ºæº–
  const scale = Math.min(vw / designW, vh / designH, 1);

  // ç½®ä¸­ï¼ˆæ°´å¹³ï¼‹å‚ç›´ï¼‰
  const contentW = designW * scale;
  const contentH = designH * scale;
  const leftPx = Math.round((vw - contentW) / 2);
  const topPx  = Math.round((vh - contentH) / 2);

  root.style.transform = `scale(${scale})`;
  root.style.left = leftPx + 'px';
  root.style.top  = topPx  + 'px';

  // çµ¦ layout å¯èƒ½ç”¨åˆ°ï¼ˆä¾‹å¦‚æƒ³æ ¹æ“šç¸®æ”¾å¾®èª¿ OFFï¼‰
  window._stageScale = scale;
}

function safeLayoutAndScale(){
  // å…ˆç”¨è¨­è¨ˆå°ºå¯¸æ’ä½
  const root = document.getElementById('scaleRoot');
  root.style.transform = 'scale(1)';
  root.style.left = '0px';
  root.style.top  = '0px';

  layout();        // ç¬¬ä¸€æ¬¡æ’ä½ï¼ˆä¾ 1280Ã—740ï¼‰

  // ç«‹åˆ»åšç¸®æ”¾ç½®ä¸­
  applyScale();

  // åœ–ç‰‡/å­—é«” ready ä¹‹å¾Œå¯èƒ½æœ‰å¾®å°å°ºå¯¸è®Šå‹• â†’ å†è£œä¸€æ¬¡ layoutï¼ˆä¸é‡è¦† scaleï¼‰
  setTimeout(() => { layout(); }, 60);
}

/* ========== æ°£çƒçµ„ / éŸ³æª” key ========== */
function getAudioKey(){
  const cur = queue[qPos];
  let w = cur.w;
  switch (w) {
    case 'A': w = 'ai'; break;
    case 'E': w = 'ee'; break;
    case 'I': w = 'y';  break;
    case 'O': w = 'oa'; break;
    case 'U': w = 'ew'; break;
    default:  w = String(w).toLowerCase();
  }
  return `${cur.r}${w}`;
}

function spawnBalloonGroup(){
  $('#balloonGroup')?.remove();
  const stage = $('#stage');

  const g = document.createElement('div');
  g.id='balloonGroup'; g.className = 'balloon-group';

  const red = document.createElement('img'); red.id='redBalloon'; red.className='balloon'; red.src='graphic/redballoon.png';
  const yel = document.createElement('img'); yel.id='yellowBalloon'; yel.className='balloon'; yel.src='graphic/yellowballoon.png';
  const box = document.createElement('img'); box.id='giftBox'; box.className='gift-box'; box.src='graphic/box1.png';

  g.append(red, yel, box);
  stage.appendChild(g);

  positionBalloonGroup();           // èˆ‡ flue å°é½Š
  g.classList.add('enterRight','float');

  const audioKey = getAudioKey();
  setTimeout(() => { playOnce(`${AUDIO_PATH}${audioKey}.mp3`); }, 1600);

  box.addEventListener('click', ()=>{
    if (bellLocked) return;
    playOnce(`${AUDIO_PATH}${audioKey}.mp3`);
  });
}

function positionBalloonGroup(){
  const g = $('#balloonGroup'); if (!g) return;
  const st = rect($('#stage'));
  const fl = rect($('#flue'));
  const gw = g.getBoundingClientRect().width || parseFloat(getComputedStyle(g).width);
  const left = (fl.left - st.left) + fl.width/2 - gw/2;  // ä¸­å¿ƒå°é½Š flue
  const top  = Math.max(10, st.height * 0.10);
  g.style.left = left + 'px';
  g.style.top  = top  + 'px';
}

/* å·¥å…· */
function playOnce(src){
  return new Promise((res)=>{ const a = new Audio(src); a.onended = ()=>res(); a.onerror=()=>res(); a.play().catch(()=>res()); });
}
function letterOf(node){
  return (node && node.dataset && node.dataset.letter)
    ? String(node.dataset.letter).toLowerCase().trim()
    : '';
}
function shuffle(a){ for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function makeQueue(set){
  const reds=[...(set.reds||[])], whites=[...(set.whites||[])];
  shuffle(reds); shuffle(whites); if(!whites.length) whites.push('a');
  const L=reds.length, must=whites.slice(0, Math.min(whites.length, L));
  const seq=[...must]; while(seq.length<L) seq.push( whites[Math.floor(Math.random()*whites.length)] );
  shuffle(seq);
  return reds.map((r,i)=>({r, w:seq[i]}));
}

/* ========== é¡Œç›®æµç¨‹ ========== */
function lockBell(lock){
  bellLocked = lock;
  const b = $('#bell');
  if (lock){ b.setAttribute('disabled',''); } else { b.removeAttribute('disabled'); }
}

function nextQuestion(){
  qPos++;
  selectedRed = selectedWhite = null;

  // é‚„åŸåº•åœ–
  $$('.tree1-bauble [data-role="base"]').forEach(im=> im.src='graphic/redbauble.png');
  $$('.tree2-bauble').forEach(w=>{
    const im = w.querySelector('[data-role="base"]');
    if (im) im.src = whiteSrc(w.dataset.letter, false);
  });
  $$('.tree1-bauble, .tree2-bauble').forEach(b=>b.classList.remove('selected'));

  if (qPos >= queue.length){ showFinish(); return; }

  const key = getAudioKey();
  if (!attemptsMap.has(key)) attemptsMap.set(key, 0);

  spawnBalloonGroup();
  lockBell(false);
}

function submit(){
  if (bellLocked) return;

  const bell = $('#bell');
  bell.classList.add('bell-press');
  setTimeout(()=>bell.classList.remove('bell-press'), 120);
  (()=>{ const a=new Audio(`${AUDIO_PATH}bell.mp3`); a.volume=0.5; a.play(); })();

  if (qPos < 0 || !queue[qPos]) return;
  if (!selectedRed || !selectedWhite) return;

  lockBell(true);
  unlockSetPicker();

  const rb  = $('#redBalloon');
  const yb  = $('#yellowBalloon');
  const box = $('#giftBox');

  const wantR = String(queue[qPos].r).toLowerCase();
  const wantW = String(queue[qPos].w).toLowerCase();
  const gotR  = letterOf(selectedRed);
  const gotW  = letterOf(selectedWhite);

  const audioKey = getAudioKey();
  attemptsMap.set(audioKey, (attemptsMap.get(audioKey) || 0) + 1);

  const redOK   = (gotR === wantR);
  const whiteOK = (gotW === wantW);

  const pop = ()=>{ try{ new Audio(`${AUDIO_PATH}pop.mp3`).play(); }catch(e){} };

  if (redOK && whiteOK){
    pop();
    const group = $('#balloonGroup');
    group?.classList.remove('float');

    Promise.all([
      fadeBalloon(rb, 'graphic/redballoonb.png'),
      fadeBalloon(yb, 'graphic/yellowballoonb.png')
    ]).then(()=>{
      setTimeout(()=>{
        if (box){
          box.style.display=''; box.style.animation='none'; void box.offsetWidth;
          box.style.animation='boxFall 2s cubic-bezier(.2,.8,.2,1) forwards';
          setTimeout(()=>{ swapSanta(SANTA_HAPPY, 500); nextQuestion(); }, 500);
          box.addEventListener('animationend', ()=>{ box.style.display='none'; box.style.animation=''; }, {once:true});
        }else{
          setTimeout(()=> swapSanta(SANTA_HAPPY, 500), 500);
          setTimeout(nextQuestion, 100);
        }
      }, 400);
    });

  } else {
    queue.push(queue[qPos]); // æ”¾åˆ°å°¾
    if (box) box.classList.remove('box-drop','box-tilt-drop','box-tilt-neg-drop');
    flyOutToLeft(null, true);
  }
}

function fadeBalloon(el, burstSrc){
  return new Promise(resolve=>{
    if (!el) return resolve();
    el.src = burstSrc;
    el.classList.add('balloon-burst-fade');
    setTimeout(()=>{ el.style.display='none'; resolve(); }, 300);
  });
}

function flyOutToLeft(after, makeSad){
  const g = $('#balloonGroup'); if (!g){ after&&after(); return; }
  g.classList.remove('enterRight');
  g.classList.add('leaver','leaveLeft');
  if (makeSad){
    setTimeout(()=>{ swapSanta(SANTA_SAD, 1200); nextQuestion(); }, 700);
  }
  g.addEventListener('animationend', ()=>{ g.remove(); after&&after(); }, {once:true});
}

function swapSanta(to, ms=1200){
  const s = $('#santa'); s.src = to; setTimeout(()=>{ s.src = SANTA_NORM; }, ms);
}

function showFinish(){
  const lines = basePairs.map(p => `${p}   x   ${attemptsMap.get(p) ? attemptsMap.get(p) : 1}`);
  document.getElementById('finishList').textContent = lines.join('\n');
  document.getElementById('finishPanel').style.display = 'flex';
  positionFinish();   // â† æ–°å¢
  lockBell(true);
  unlockSetPicker();
}

/* Set é¸å–® */
function unlockSetPicker(){
  const picker = document.querySelector('#setPicker select');
  const btn = document.querySelector('#setGoBtn');
  picker && picker.removeAttribute('disabled');
  btn && btn.removeAttribute('disabled');
}

$('#bell').addEventListener('click', submit);
window.addEventListener('keydown', e=>{ if(e.key==='Enter') submit(); });

$('#setGoBtn').addEventListener('click', ()=>{
  const val = $('#setPickerSelect').value;
  if (val === '') return;

  currentSetIndex = parseInt(val, 10);
  attemptsMap.clear();
  $('#finishPanel').style.display = 'none';
  qPos = -1;

  const set = SETS[currentSetIndex];
  queue = makeQueue(set);
  basePairs = queue.map(q => {
    let w = q.w;
    if (w === 'A') w = 'ai';
    else if (w === 'E') w = 'ee';
    else if (w === 'I') w = 'y';
    else if (w === 'O') w = 'oa';
    else if (w === 'U') w = 'ew';
    return `${q.r}${String(w).toLowerCase()}`;
  });

  safeLayoutAndScale();
  nextQuestion();
});

/* Snow */
function whenImagesReady(images, cb){
  let left = images.length; if (!left) return cb();
  images.forEach(img=>{
    if (img.complete) { if(--left===0) cb(); }
    else {
      img.addEventListener('load', ()=>{ if(--left===0) cb(); });
      img.addEventListener('error',()=>{ if(--left===0) cb(); });
    }
  });
}
const rnd = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;
function createSnowflake(stage){
  const wrap=document.createElement('div'); wrap.className='snowWrap';
  const flake=document.createElement('img'); flake.src='graphic/snow.png'; flake.alt='snow'; flake.className='snow';
  const sizePx = rnd(10,30);
  const leftPx = rnd(0, 1280 - sizePx);
  flake.style.width = sizePx + 'px';
  wrap.style.left = leftPx + 'px';
  const duration = rnd(6, 12);
  const delay = Math.random() * 0.8;
  flake.style.animation = `snow-fall ${duration}s linear ${delay}s forwards`;
  const amp = rnd(10, 40), sway = rnd(5, 11);
  wrap.style.setProperty('--amp', amp + 'px');
  wrap.style.animation = `snow-sway ${sway}s ease-in-out ${Math.random()}s infinite alternate`;
  flake.style.transform = `rotate(${rnd(-25,25)}deg)`;
  flake.addEventListener('animationend', ()=> wrap.remove());
  wrap.appendChild(flake); stage.appendChild(wrap); return wrap;
}
function spawnSnowBatch(){ const stage=$('#stage'); const count=rnd(3,7); for(let i=0;i<count;i++) createSnowflake(stage); }
function startSnow(){ spawnSnowBatch(); setInterval(spawnSnowBatch, rnd(800,1600)); }

/* èµ·å‹• */
const imgs = Array.from(document.querySelectorAll('img.sprite'));
whenImagesReady(imgs, ()=>{
  safeLayoutAndScale();
  if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) startSnow();
  lockBell(true);
  unlockSetPicker();
});
window.addEventListener('resize', safeLayoutAndScale);
window.addEventListener('orientationchange', safeLayoutAndScale);
</script>
</body>
</html>
