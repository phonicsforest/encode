<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Santa Flue – Multi Sets</title>
<style>
  html, body { height:100%; margin:0; overflow:hidden; }
  .stage {
    position:relative; width:100vw; height:100vh; overflow:hidden;
    background:url('graphic/background.png') center / cover no-repeat;
  }

  /* Sprites */
  .sprite { position:absolute; user-select:none; -webkit-user-drag:none; pointer-events:none; height:auto; max-width:50vw; }
  #flue  { height:min(15vh, 38vw); z-index:20; bottom:0; }  /* flue 永遠最高層 */
  #santa { height:min(50vh, 42vw); z-index:4; bottom:0; }
  #treeLeft   { height:min(90vh, 90vw); z-index:3; bottom:0; }
  #treeBehind { height:min(100vh,100vw); z-index:2; bottom:0; }
  #treeFront  { height:min(40vh, 40vw); z-index:1; bottom:0; }
  #bell { height:min(18vh,18vw); z-index:5; transform:rotate(-30deg); pointer-events:auto; transition:transform .15s ease, filter .2s ease; bottom:40px; }
  #bell:hover { transform:rotate(-20deg) scale(1.08); filter:brightness(1.15); }
  #bell.bell-press { transform:rotate(-20deg) scale(1.05); filter:brightness(1.1); }

  /* 雪花 */
  .snowWrap { position:absolute; top:-10vh; pointer-events:none; z-index:6; will-change:transform; }
  .snow { position:relative; opacity:.95; will-change:transform, opacity; display:block; }
  @keyframes snow-fall { to { transform: translateY(110vh) rotate(360deg); opacity:.9; } }
  @keyframes snow-sway { 0%{transform:translateX(calc(var(--amp)*-1));} 50%{transform:translateX(var(--amp));} 100%{transform:translateX(calc(var(--amp)*-1));} }

  /* 樹飾物 */
  .tree1-bauble, .tree2-bauble { position:absolute; z-index:4; aspect-ratio:1/1; cursor:pointer; transform: scale(1.5);   /* 👈 一開始就放大 1.3 倍 */
  transition: transform .18s ease; }
  .tree1-bauble img, .tree2-bauble img { width:100%; height:100%; object-fit:contain; display:block; }
  .baubleLetter, .tree2-letter {
    position:absolute; left:50%; bottom:18%; transform:translateX(-50%);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang HK";
    text-shadow:0 1px 2px rgba(0,0,0,.35);
  }
  .baubleLetter { color:#fff; font-weight:500; }
  .tree2-letter { color:#d01010; font-weight:700; }

  /* hover 放大（連字） */
  .tree1-bauble:hover, .tree2-bauble:hover { transform: scale(1.6); }

  /* 🎈 Balloon group */
  .balloon-group{
    position:absolute; z-index:7;
    width:min(14vw, 260px);
    aspect-ratio:1/1; pointer-events:none;
  }
  .balloon-group .balloon{ position:absolute; width:60%; height:auto; }
  #redBalloon{    left:20%; top:0%;   z-index:1; }
  #yellowBalloon{ left:50%; top:10%;  z-index:2; }
  #giftBox{ pointer-events:auto; cursor:pointer; position:absolute; width:58%; left:33%; top:90%; z-index:3; }

  /* 入/出場（出場慢 2s，不透明） */
  #balloonGroup.enterRight { animation: groupInRight 1.6s ease-out forwards; }
  #balloonGroup.leaveLeft  { animation: groupOutLeft 2s ease-out forwards; }
  @keyframes groupInRight  { from { transform: translateX(60vw); } to { transform: translateX(0); } }
  @keyframes groupOutLeft  { from { transform: translateX(0); }    to { transform: translateX(-80vw); } }

  /* *_b 漸隱（極短） */
  .balloon-burst-fade { animation: burstFade .025s linear forwards; }
  @keyframes burstFade { from{opacity:1} to{opacity:0} }

  /* GiftBox 動效 & 掉落（你改成 2.0s） */
  .box-drop { animation: boxFall 2s cubic-bezier(.2,.8,.2,1) forwards; }
  @keyframes boxFall {
    0%   { transform: translateY(0); opacity:1; }
    85%  { transform: translateY(75vh); opacity:1; }
    100% { transform: translateY(80vh); opacity:0; }
  }
  .box-tilt-drop       { transform: translateY(30px) rotate(-25deg);    transition: transform .25s ease; }
  .box-tilt-neg-drop   { transform: translateY(30px) rotate(25deg);   transition: transform .25s ease; }

  /* 選單：置中疊背景 */
  #setPicker {
    position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
    background: rgba(255,255,255,.85); border-radius: 8px; padding: 6px 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,.2); z-index: 9999; font-size: 14px;
  }
  #setPicker select, #setPicker button { font-size:14px; padding:4px 8px; }

  /* Finish 面板 */
  #finishPanel{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35); z-index:99999;
  }
  #finishCard{
    background:#fff; border-radius:12px; padding:16px 18px; min-width:260px; max-width:90vw;
    box-shadow:0 10px 30px rgba(0,0,0,.25); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  #finishCard h2{ margin:.2em 0 .3em; font-size:20px; text-align:center; }
  #finishList{ font-size:16px; line-height:1.6; white-space:pre; margin-bottom:10px; }
  #playAgainBtn{ display:block; margin:6px auto 0; padding:6px 12px; border-radius:8px; border:1px solid #ddd; background:#f6f6f6; cursor:pointer; }
</style>
</head>
<body>
  <!-- 選單（去掉 “Set” 字） -->
  <div id="setPicker">
    <select id="setPickerSelect">
      <option value="">-----</option>
      <option value="0">1</option>
      <option value="1">2</option>
      <option value="2">3</option>
      <option value="3">4</option>
      <option value="4">5</option>
      <option value="5">6</option>
      <option value="6">7</option>
      <option value="7">8</option>
      <option value="8">9</option>
      <option value="9">10</option>
    </select>
    <button id="setGoBtn">Go</button>
  </div>

  <div class="stage" id="stage">
    <img id="flue" class="sprite" src="graphic/flue.png" alt="flue" />
    <img id="santa" class="sprite" src="graphic/santa.png" alt="santa" />
    <img id="bell" class="sprite" src="graphic/bell.png" alt="bell" />
    <img id="treeLeft" class="sprite" src="graphic/tree.png" alt="tree left" />
    <img id="treeBehind" class="sprite" src="graphic/tree.png" alt="tree behind santa" />
    <img id="treeFront" class="sprite" src="graphic/tree.png" alt="tree front-under" />
  </div>

  <!-- Finish 面板 -->
  <div id="finishPanel">
    <div id="finishCard">
      <h2>Finish!</h2>
      <div id="finishList"></div>
      <button id="playAgainBtn">Play Again</button>
    </div>
  </div>

<script>
  const SANTA_HAPPY = 'graphic/santa_happy.png';
  const SANTA_SAD   = 'graphic/santa_sad.png';
  const SANTA_NORM  = 'graphic/santa.png';

  /* 你更新的 SETS（c → k） */
  const SETS = [
    { reds: ['b','k','d','f','g','h','n'], whites: ['a'] },
    { reds: ['l','m','j','p','r','s','t'], whites: ['a'] },
    { reds: ['b','k','d','f','g','h','n'], whites: ['a','i'] },
    { reds: ['l','m','n','p','r','s','t'], whites: ['a','i'] },
    { reds: ['b','k','d','f','g','h','n'], whites: ['a','i','e'] },
    { reds: ['l','m','n','p','r','s','t'], whites: ['a','i','e'] },
    { reds: ['b','k','d','f','g','h','n'], whites: ['a','i','e','o'] },
    { reds: ['l','m','n','p','r','s','t'], whites: ['a','i','e','o'] },
    { reds: ['b','k','d','f','g','h','n'], whites: ['a','i','e','o','u'] },
    { reds: ['l','m','n','p','r','s','t'], whites: ['a','i','e','o','u'] },
  ];

  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const rect = el => el.getBoundingClientRect();

  let currentSetIndex = -1;
  let currentQueue = [];     // [{r,w}, ...]
  let basePairs = [];        // 初始題目（Finish 用）
  let qIndex = -1;
  let selectedRed = null, selectedWhite = null;

  // 計「答咗幾次先啱」
  const attemptsMap = {};    // pair -> 次數（包括最後一次正確）

  /* 版面 */
  function layout(){
    const stage = $('#stage'), flue = $('#flue'), santa = $('#santa'), bell = $('#bell');
    const treeLeft = $('#treeLeft'), treeBehind = $('#treeBehind'), treeFront = $('#treeFront');
    const st = rect(stage);

    const flBox = rect(flue);
    flue.style.left = (st.width/2 - flBox.width/2) + 'px';
    flue.style.bottom = '0px';
    const fl = rect(flue);

    santa.style.left = (fl.right - st.left) + 'px';
    santa.style.bottom = '0px';

    const sa = rect(santa);
    const saMid = (sa.left+sa.right)/2 - st.left;
    bell.style.left = (saMid + 120) + 'px';
    bell.style.bottom = '40px';

    const tl = rect(treeLeft);
    treeLeft.style.left = Math.max(0, fl.left - st.left - tl.width) + 'px';

    const saMidX = (sa.left + sa.right)/2 - st.left;
    treeBehind.style.left = saMidX + 'px';

    const tb = rect(treeBehind);
    treeFront.style.left = (tb.left - st.left + tb.width/2) + 'px';

    if (currentSetIndex >= 0){
      buildTree1Baubles(SETS[currentSetIndex].reds);
      buildTree2Baubles(SETS[currentSetIndex].whites);
    }
    positionBalloonGroup();
  }

  /* 紅球（左樹，Z 形） */
  function buildTree1Baubles(letters){
    const stage = $('#stage'), tree = $('#treeLeft');
    const sRect = rect(stage), tRect = rect(tree);
    $$('.tree1-bauble').forEach(n=>n.remove());

    const w = tRect.width, h = tRect.height;
    const originX = tRect.left - sRect.left;
    const originY = tRect.top  - sRect.top;

    const spots = [
      {x: 0.5, y: 0.08},
      {x: 0.68, y: 0.25},
      {x: 0.34, y: 0.38},
      {x:  0.7, y: 0.50},
      {x:  0.2, y: 0.60},
      {x:  0.9, y: 0.70},
      {x:  0.5, y: 0.76},
    ];
    const size = Math.max(28, Math.min(w * 0.22 * 1.3, 120 * 1.3));
    const L = Math.min(letters.length, spots.length);

    for (let i=0;i<L;i++){
      const pos = spots[i];
      const wrap = document.createElement('div');
      wrap.className = 'tree1-bauble';
      wrap.style.width = size+'px';
      wrap.style.height= size+'px';
      wrap.style.left  = (originX + pos.x*w - size/2) + 'px';
      wrap.style.top   = (originY + pos.y*h - size/2) + 'px';

      const img = document.createElement('img');
      img.src = 'graphic/redbauble.png'; img.alt = 'red bauble';

      const span = document.createElement('span');
      span.className = 'baubleLetter';
      span.textContent = letters[i];
      span.style.fontSize = (size * 0.5) + 'px';

      wrap.append(img, span);
      stage.appendChild(wrap);

      wrap.addEventListener('click', ()=>{
        // 還原其他紅球圖
        $$('.tree1-bauble').forEach(n=>{
          n.classList.remove('selected');
          const im = n.querySelector('img');
          if (im) im.src = 'graphic/redbauble.png';
        });
        // 自己變 glow
        wrap.classList.add('selected');
        const im = wrap.querySelector('img');
        if (im) im.src = 'graphic/redbauble_glow.png';
        selectedRed = wrap;
      });
    }
  }

  /* 白球（中樹） */
  function buildTree2Baubles(letters){
    const stage = $('#stage'), tree = $('#treeBehind');
    const sRect = rect(stage), tRect = rect(tree);
    $$('.tree2-bauble').forEach(n=>n.remove());

    const w = tRect.width, h = tRect.height;
    const originX = tRect.left - sRect.left;
    const originY = tRect.top  - sRect.top;

    const spots = [
      {x: 0.52, y: 0.18},
      {x: 0.70, y: 0.33},
      {x: 0.34, y: 0.36},
      {x: 0.75, y: 0.53},
      {x: 0.42, y: 0.59},
      {x: 0.88, y: 0.66},
      {x: 0.52, y: 0.72},
    ];
    const size = Math.max(28, Math.min(w * 0.27, 130));
    const L = Math.min(letters.length, spots.length);

    for (let i=0;i<L;i++){
      const pos = spots[i];
      const wrap = document.createElement('div');
      wrap.className = 'tree2-bauble';
      wrap.style.width = size+'px';
      wrap.style.height= size+'px';
      wrap.style.left  = (originX + pos.x*w - size/2) + 'px';
      wrap.style.top   = (originY + pos.y*h - size/2) + 'px';

      const img = document.createElement('img');
      img.src = 'graphic/whitebauble.png'; img.alt = 'white bauble';

      const span = document.createElement('span');
      span.className = 'tree2-letter';
      span.textContent = letters[i];
      span.style.fontSize = (size * 0.52) + 'px';

      wrap.append(img, span);
      stage.appendChild(wrap);

      wrap.addEventListener('click', ()=>{
        // 還原其他白球圖
        $$('.tree2-bauble').forEach(n=>{
          n.classList.remove('selected');
          const im = n.querySelector('img');
          if (im) im.src = 'graphic/whitebauble.png';
        });
        // 自己變 glow
        wrap.classList.add('selected');
        const im = wrap.querySelector('img');
        if (im) im.src = 'graphic/whitebauble_glow.png';
        selectedWhite = wrap;
      });
    }
  }

  /* Balloon group */
  function spawnBalloonGroup(){
    const stage = $('#stage');
    $('#balloonGroup')?.remove();

    const g = document.createElement('div');
    g.id = 'balloonGroup'; g.className = 'balloon-group';

    const red = document.createElement('img');
    red.id='redBalloon'; red.className='balloon'; red.src='graphic/redballoon.png';
    const yel = document.createElement('img');
    yel.id='yellowBalloon'; yel.className='balloon'; yel.src='graphic/yellowballoon.png';
    const box = document.createElement('img');
    box.id='giftBox'; box.className='gift-box'; box.src='graphic/box1.png';

    g.append(red, yel, box);
    stage.appendChild(g);

    positionBalloonGroup();
    g.classList.add('enterRight');

    const pair = getCurrentPair();
    setTimeout(() => { playOnce(`audio/${pair}.mp3`); }, 1600);

    box.addEventListener('click', ()=>{
      // click 先播
      box.classList.add('gift-pulse');
      setTimeout(()=>box.classList.remove('gift-pulse'), 400);
      playOnce(`audio/${pair}.mp3`);
    });
  }

  function positionBalloonGroup(){
    const g = $('#balloonGroup'); if (!g) return;
    const st = rect($('#stage'));
    const fl = rect($('#flue'));
    const gw = g.getBoundingClientRect().width || parseFloat(getComputedStyle(g).width);
    const left = (fl.left - st.left) + fl.width/2 - gw/2 -20;
    const top  = Math.max(10, st.height * 0.10);
    g.style.left = left + 'px';
    g.style.top  = top  + 'px';
  }

  /* 音頻 / 工具 */
  function playOnce(src){
    return new Promise((res)=>{ const a = new Audio(src); a.onended = ()=>res(); a.onerror=()=>res(); a.play().catch(()=>res()); });
  }
  function letterOf(node){
    const span = node?.querySelector('.baubleLetter, .tree2-letter');
    return span ? span.textContent.trim().toLowerCase() : '';
  }
  function makeQueueForSet(set){
    const reds = [...set.reds];
    shuffle(reds);
    const q = reds.map(r => ({ r, w: set.whites[Math.floor(Math.random() * set.whites.length)] }));
    return q;
  }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function getCurrentPair(){
    const cur = currentQueue[qIndex];
    return `${cur.r}${cur.w}`;
  }
  function fadeBalloon(el, burstSrc, dur=25){
    return new Promise(resolve=>{
      if (!el) return resolve();
      el.src = burstSrc;
      el.classList.add('balloon-burst-fade');
      setTimeout(()=>{ el.style.display='none'; resolve(); }, dur);
    });
  }

  async function nextQuestion(){
    qIndex++;
    if (qIndex >= currentQueue.length){
      showFinish();
      return;
    }
    selectedRed = null; selectedWhite = null;
    // 還原 glow 圖
    $$('.tree1-bauble img').forEach(im=> im.src='graphic/redbauble.png');
    $$('.tree2-bauble img').forEach(im=> im.src='graphic/whitebauble.png');
    $$('.tree1-bauble, .tree2-bauble').forEach(b=>b.classList.remove('selected'));

    spawnBalloonGroup();
  }

  /* 提交 */
  function submit(){
    $('#bell').classList.add('bell-press'); setTimeout(()=>$('#bell').classList.remove('bell-press'), 120);
    if (qIndex < 0 || !currentQueue[qIndex]) return;
    if (!selectedRed || !selectedWhite) return;

    const rb = $('#redBalloon');
    const yb = $('#yellowBalloon');
    const box = $('#giftBox');

    const pair = getCurrentPair();           // e.g. 'ka'
    const wantR = pair[0], wantW = pair[1];
    const gotR  = letterOf(selectedRed);
    const gotW  = letterOf(selectedWhite);

    // 計次數（包括今次）
    attemptsMap[pair] = (attemptsMap[pair] || 0) + 1;

    const redCorrect   = (gotR === wantR);
    const whiteCorrect = (gotW === wantW);

    function pop(){ try{ new Audio('audio/pop.mp3').play(); }catch(e){} }

    if (redCorrect && whiteCorrect){
      // ✅ 雙對：兩個氣球漸隱 → 0.3s → giftbox 掉（2.0s）
      pop();
      Promise.all([
        fadeBalloon(rb, 'graphic/redballoonb.png', 25),
        fadeBalloon(yb, 'graphic/yellowballoonb.png', 25)
      ]).then(()=>{
        setTimeout(()=>{
          if (box){
            box.style.display='';
            box.classList.remove('box-tilt-drop','box-tilt-neg-drop');
            box.classList.add('box-drop');
            // drop 開始 1 秒 → happy
            setTimeout(()=> swapSanta(SANTA_HAPPY, 1200), 1000);
            box.addEventListener('animationend', () => {
              box.style.display = 'none';
              setTimeout(nextQuestion, 150);
            }, { once:true });
          } else {
            setTimeout(()=> swapSanta(SANTA_HAPPY, 900), 1000);
            setTimeout(nextQuestion, 300);
          }
        }, 300);
      });

    } else {
      // 答錯：把題目排去隊尾
      currentQueue.push(currentQueue[qIndex]);

      if (redCorrect && !whiteCorrect){
        // 🔴 紅啱白錯 → redballoonb；🎁 向下30px + 旋轉 +25°
        pop();
        fadeBalloon(rb, 'graphic/redballoonb.png', 25);
        if (box){
          box.style.display='';
          box.classList.remove('box-drop','box-tilt-neg-drop');
          box.classList.add('box-tilt-drop');
        }
        setTimeout(()=>{
          const g = $('#balloonGroup');
          if (g){
            g.classList.remove('enterRight');
            g.classList.add('leaveLeft');
            // 起飛 1 秒 → sad
            setTimeout(()=> swapSanta(SANTA_SAD, 900), 1000);
            g.addEventListener('animationend', ()=> nextQuestion(), {once:true});
          } else { setTimeout(()=> swapSanta(SANTA_SAD, 900), 1000); setTimeout(nextQuestion, 150); }
        }, 375);

      } else if (!redCorrect && whiteCorrect){
        // 🟡 白啱紅錯 → yellowballoonb；🎁 向下30px + 旋轉 -25°
        pop();
        fadeBalloon(yb, 'graphic/yellowballoonb.png', 25);
        if (box){
          box.style.display='';
          box.classList.remove('box-drop','box-tilt-drop');
          box.classList.add('box-tilt-neg-drop');
        }
        setTimeout(()=>{
          const g = $('#balloonGroup');
          if (g){
            g.classList.remove('enterRight');
            g.classList.add('leaveLeft');
            setTimeout(()=> swapSanta(SANTA_SAD, 900), 1000);
            g.addEventListener('animationend', ()=> nextQuestion(), {once:true});
          } else { setTimeout(()=> swapSanta(SANTA_SAD, 900), 1000); setTimeout(nextQuestion, 150); }
        }, 375);

      } else {
        // ❌ 全錯：立即起飛；起飛 1 秒 → sad
        const g = $('#balloonGroup');
        if (g){
          g.classList.remove('enterRight');
          g.classList.add('leaveLeft');
          setTimeout(()=> swapSanta(SANTA_SAD, 900), 1000);
          g.addEventListener('animationend', ()=> nextQuestion(), {once:true});
        } else { setTimeout(()=> swapSanta(SANTA_SAD, 900), 1000); setTimeout(nextQuestion, 150); }
      }
    }
  }

  function swapSanta(to, ms=1200){
    const s = $('#santa'); s.src = to; setTimeout(()=>{ s.src = SANTA_NORM; }, ms);
  }

  /* Finish：列出所有題目（「答咗幾次先啱」） + Play Again */
  function showFinish(){
    const lines = basePairs.map(p => `${p}   x   ${attemptsMap[p] ? attemptsMap[p] : 1}`);
    $('#finishList').textContent = lines.join('\n');
    $('#finishPanel').style.display = 'flex';
  }

  /* 事件 */
  $('#bell').addEventListener('click', submit);
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') submit(); });

  $('#setGoBtn').addEventListener('click', ()=>{
    const val = $('#setPickerSelect').value;
    if (val === '') return;
    currentSetIndex = parseInt(val, 10);

    // reset
    for (const k in attemptsMap) delete attemptsMap[k];
    $('#finishPanel').style.display = 'none';

    // 畫 baubles
    buildTree1Baubles(SETS[currentSetIndex].reds);
    buildTree2Baubles(SETS[currentSetIndex].whites);

    // 起題
    currentQueue = makeQueueForSet(SETS[currentSetIndex]);
    basePairs = currentQueue.map(q => `${q.r}${q.w}`);
    qIndex = -1;
    nextQuestion();
  });

  $('#playAgainBtn').addEventListener('click', ()=>{
    $('#finishPanel').style.display = 'none';
    // 返到選單，再揀 set → Go
  });

  /* 雪花 & 初始 */
  function whenImagesReady(images, cb){
    let left = images.length; if (!left) return cb();
    images.forEach(img=>{
      if (img.complete) { if(--left===0) cb(); }
      else {
        img.addEventListener('load', ()=>{ if(--left===0) cb(); });
        img.addEventListener('error',()=>{ if(--left===0) cb(); });
      }
    });
  }
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function rand(min,max){ return Math.random()*(max-min)+min; }
  function createSnowflake(stage){
    const wrap=document.createElement('div'); wrap.className='snowWrap';
    const flake=document.createElement('img'); flake.src='graphic/snow.png'; flake.alt='snow'; flake.className='snow';
    const stR=rect(stage); const sizeVw=rand(0.8,2.5); flake.style.width=sizeVw+'vw';
    const leftPx=rand(0, Math.max(0, stR.width - (stR.width*sizeVw/100))); wrap.style.left=leftPx+'px';
    const duration=rand(6,12), delay=rand(0,0.8); flake.style.animation=`snow-fall ${duration}s linear ${delay}s forwards`;
    const amp=rand(10,40), sway=rand(5,11); wrap.style.setProperty('--amp', amp+'px'); wrap.style.animation=`snow-sway ${sway}s ease-in-out ${Math.random()}s infinite alternate`;
    flake.style.transform=`rotate(${rand(-25,25)}deg)`; flake.addEventListener('animationend', ()=>wrap.remove());
    wrap.appendChild(flake); stage.appendChild(wrap); return wrap;
  }
  function spawnSnowBatch(){ const stage=$('#stage'); const count=randInt(3,7); for(let i=0;i<count;i++) createSnowflake(stage); }
  function startSnow(){ spawnSnowBatch(); setInterval(spawnSnowBatch, randInt(800,1600)); }

  const imgs = Array.from(document.querySelectorAll('img.sprite'));
  whenImagesReady(imgs, ()=>{
    layout();
    window.addEventListener('resize', layout);
    window.addEventListener('orientationchange', layout);
    if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) startSnow();
  });
</script>
</body>
</html>
