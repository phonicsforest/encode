<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Santa Flue â€“ Multi Sets</title>
<style>
  html, body { height:100%; margin:0; overflow:hidden; }
  
/* âœ… å¤–æ¡†ï¼šé‹ªæ»¿æ•´å€‹è¢å¹•ï¼ˆèƒŒæ™¯è‡ªå‹•å¡«æ»¿ï¼‰ */
#gameWrap{
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #bfe4f9; /* é€™å€‹è—è‰²èƒŒæ™¯æœƒå¡«æ»¿å…¨å± */
  z-index: 0;
}

/* âœ… éŠæˆ²å€åŸŸï¼šä¿æŒæ¯”ä¾‹ï¼Œä½†è‡ªå‹•æ”¾å¤§è‡³è²¼æ»¿è¢å¹•ï¼ˆä¸ç•™é»‘é‚Šï¼‰ */
#gameViewport{
  position: relative;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  background: #bfe4f9; /* ä¿éšªï¼Œç¢ºä¿å³ä½¿èƒŒæ™¯åœ–æœªè¼‰å®Œéƒ½æœ‰è—è‰² */
}
.stage {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: url('graphic/background.png') center / cover no-repeat;
}
  /* Sprites */
  .sprite { position:absolute; user-select:none; -webkit-user-drag:none; pointer-events:none; height:auto; max-width:50vw; }
  #flue  { height:min(15vh, 38vw); z-index:20; bottom:0; }  /* flue æ°¸é æœ€é«˜å±¤ */
  #santa { height:min(50vh, 42vw); z-index:4; bottom:0; }
  #treeLeft   { height:min(90vh, 90vw); z-index:3; bottom:0; }
  #treeBehind { height:min(100vh,100vw); z-index:2; bottom:0; }
  #treeFront  { height:min(40vh, 40vw); z-index:1; bottom:0; }
  #bell { height:min(18vh,18vw); z-index:5; transform:rotate(-30deg); pointer-events:auto; transition:transform .15s ease, filter .2s ease; bottom:40px; }
  #bell:hover { transform:rotate(-20deg) scale(1.08); filter:brightness(1.15); }
  #bell.bell-press { transform:rotate(-20deg) scale(1.05); filter:brightness(1.1); }
  #bell[disabled]{ pointer-events:none; filter:none; opacity:1; } /* disable äº¦ä¸é€æ˜ */

  /* é›ªèŠ± */
  .snowWrap { position:absolute; top:-10vh; pointer-events:none; z-index:6; will-change:transform; }
  .snow { position:relative; opacity:.95; will-change:transform, opacity; display:block; }
  @keyframes snow-fall { to { transform: translateY(110vh) rotate(360deg); opacity:.9; } }
  @keyframes snow-sway { 0%{transform:translateX(calc(var(--amp)*-1));} 50%{transform:translateX(var(--amp));} 100%{transform:translateX(calc(var(--amp)*-1));} }

  /* æ¨¹é£¾ç‰©ï¼ˆåˆå§‹å·²æ”¾å¤§ï¼‰ */
  .tree1-bauble, .tree2-bauble { position:absolute; z-index:4; aspect-ratio:1/1; cursor:pointer; transform: scale(1.5); transition: transform .18s ease; }
  .tree1-bauble:hover, .tree2-bauble:hover { transform: scale(1.6); }
  .tree1-bauble img, .tree2-bauble img { width:100%; height:100%; object-fit:contain; display:block; }
  .baubleLetter, .tree2-letter {
    position:absolute; left:50%; bottom:12%; transform:translateX(-50%);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang HK";
    text-shadow:0 1px 2px rgba(0,0,0,.35);
  }
  .baubleLetter { color:#fff; font-weight:500; }
  .tree2-letter { color:#d01010; font-weight:700; }
  /* é¸ä¸­ï¼šæ› glow åœ– */
  .tree1-bauble.selected img{ content:url('graphic/redbauble_glow.png'); }
  .tree2-bauble.selected img{ content:url('graphic/whitebauble_glow.png'); }

  /* ğŸˆ Balloon group */
  .balloon-group{
    position:absolute; z-index:7;
    width:min(14vw, 260px);
    aspect-ratio:1/1; pointer-events:none;
  }
  .balloon-group .balloon{ position:absolute; width:60%; height:auto; }
  #redBalloon{    left:20%; top:0%;   z-index:1; }
  #yellowBalloon{ left:50%; top:10%;  z-index:2; }
  #giftBox{ pointer-events:auto; cursor:pointer; position:absolute; width:58%; left:33%; top:90%; z-index:3; transition: transform .25s ease; }

/* ğŸª¶ æ°£çƒé£„æµ®å‹•ç•« */
@keyframes balloonFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

#redBalloon, #yellowBalloon, #giftBox {
  animation: balloonFloat 2.8s ease-in-out infinite;
}


  /* å…¥/å‡ºå ´ï¼ˆå‡ºå ´ 2sï¼Œä¸é€æ˜ï¼‰ */
  #balloonGroup.enterRight { animation: groupInRight 1.6s ease-out forwards; }
  #balloonGroup.leaveLeft  { animation: groupOutLeft 2s ease-out forwards; }
  @keyframes groupInRight  { from { transform: translateX(60vw); } to { transform: translateX(0); } }
  @keyframes groupOutLeft  { from { transform: translateX(0); }    to { transform: translateX(-110vw); } }

  /* *_b æ¥µé€Ÿæ¼¸éš± */
  .balloon-burst-fade { animation: burstFade .25s linear forwards; }
  @keyframes burstFade { from{opacity:1} to{opacity:0} }

  /* GiftBox æ‰è½ï¼ˆ2sï¼‰ + æ–œè½ */
  .box-drop { animation: boxFall 2s cubic-bezier(.2,.8,.2,1) forwards; }
  @keyframes boxFall {
    0%   { transform: translateY(0); opacity:1; }
    85%  { transform: translateY(75vh); opacity:1; }
    100% { transform: translateY(80vh); opacity:0; }
  }
  .box-tilt-drop     { transform: translateY(30px) rotate(-25deg); transition: transform .25s ease; }
  .box-tilt-neg-drop { transform: translateY(30px) rotate(25deg);  transition: transform .25s ease; }

  /* é¸å–®ï¼šç½®ä¸­ç–ŠèƒŒæ™¯ */
#setPicker{
  position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
  background: rgba(255,255,255,.85);
  border-radius: 8px; padding: 6px 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 10000; font-size: 14px; display:flex; gap:10px; align-items:center;
}
/* ä¸‹æ‹‰é¸å–®æ¨£å¼ï¼ˆå¸¶æ¸…æ™°é‚Šæ¡†ï¼‰ */
#setPicker select{
  padding: 6px 12px;
  border: 2px solid #2b2b2b;     /* æ·±è‰²é‚Šæ¡†ï¼ˆå·¦é‚Šå°±æœƒè¦‹åˆ°ï¼‰ */
  border-radius: 10px;
  background: #fff;
  color: #1f1f1f;
  appearance: none;              /* éœ€è¦ä¿ç•™çš„è©±å¯åˆª */
}
#setPicker select:focus{
  outline: 2px solid rgba(200,16,46,.35);
  outline-offset: 2px;
}

/* ğŸ„ å°åœ“å½¢ Go æ£ */
#setGoBtn {
  background: #c8102e;       /* è–èª•ç´… */
  color: white;
  border: none;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s ease, background 0.3s ease;
}
#setGoBtn:hover {
  background: #e01e37;
  transform: scale(1.1);
}
@keyframes bob {
  0%{transform:translateY(0)}
  50%{transform:translateY(-8px)}
  100%{transform:translateY(0)}
}
/* åªè¦ balloonGroup æœ‰ .floatï¼Œä¸‰ä»¶ç‰©ä»¶ä¸€é½Šé£„ */
.balloon-group.float #redBalloon,
.balloon-group.float #yellowBalloon,
.balloon-group.float #giftBox{
  animation:bob 2.6s ease-in-out infinite;
}

  /* Finish é¢æ¿ï¼ˆæ”¶çª„ï¼‰ */
#finishPanel{ 
  position:absolute; inset:0; 
  display:none; align-items:center; justify-content:center; 
  background: transparent; z-index: 9000; pointer-events:none; 
}
  #finishCard{
    background:transparent; border-radius:12px; padding:16px 18px;
    width:clamp(260px,15vw,380px); max-width:90vw;
   font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
    text-align:center;
  }
.balloon-group.leaver { z-index: 9; }  /* èˆŠçµ„èµ·é£›æ™‚æ”¾åˆ°æœ€ä¸Š */

  #finishCard h2{ margin:.2em 0 .3em; font-size:30px;color:#8d0f0f;   /* ğŸ”´ æ·±ç´…è‰² */ }
  #finishList{ font-size:20px; line-height:1.6; white-space:pre; margin-bottom:10px; }
  #playAgainBtn{ display:block; margin:6px auto 0; padding:8px 16px; border-radius:999px; border:2px solid #8d0f0f; background:#fff; color:#8d0f0f; font-weight:700; cursor:pointer; }
  #playAgainBtn:hover{ background:#8d0f0f; color:#fff; }
</style>
</head>
<body>
 
  <!-- é¸å–® -->
<div id="gameWrap">
    <div id="gameViewport">
 
 <div id="setPicker">
    <select id="setPickerSelect">
      <option value="">-----</option>
      <option value="0">Set 11</option>
      <option value="1">Set 2</option>
      <option value="2">Set 3</option>
      <option value="3">Set 4</option>
      <option value="4">Set 5</option>
      <option value="5">Set 6</option>
      <option value="6">Set 7</option>
      <option value="7">Set 8</option>
      <option value="8">Set 9</option>
      <option value="9">Set 10</option>
      </select>
    <button id="setGoBtn">Go</button>
  </div>

  <div class="stage" id="stage">
    <img id="flue" class="sprite" src="graphic/flue.png" alt="flue" />
    <img id="santa" class="sprite" src="graphic/santa.png" alt="santa" />
    <img id="bell" class="sprite" src="graphic/bell.png" alt="bell" />
    <img id="treeLeft" class="sprite" src="graphic/tree.png" alt="tree left" />
    <img id="treeBehind" class="sprite" src="graphic/tree.png" alt="tree behind santa" />
    <img id="treeFront" class="sprite" src="graphic/tree.png" alt="tree front-under" />
  </div>
  <!-- Finish é¢æ¿ -->
  <div id="finishPanel">
    <div id="finishCard">
      <h2>Finish!</h2>
      <div id="finishList"></div>
    </div>
  </div>
 </div>
  </div>
<script>
  const SANTA_HAPPY = 'graphic/santa_happy.png';
  const SANTA_SAD   = 'graphic/santa_sad.png';
  const SANTA_NORM  = 'graphic/santa.png';

  /* ä½ æ›´æ–°çš„ SETSï¼ˆc â†’ kï¼‰ */
  const SETS = [
    { reds: ['b','k','d','f','g','h','n'], whites: ['a'] },
    { reds: ['l','m','j','p','r','s','t'], whites: ['a'] },
    { reds: ['b','k','d','f','g','h','n'], whites: ['a','i'] },
    { reds: ['l','m','j','p','r','s','t'], whites: ['a','i'] },
    { reds: ['b','k','d','f','g','h','n'], whites: ['a','i','e'] },
    { reds: ['l','m','j','p','r','s','t'], whites: ['a','i','e'] },
    { reds: ['b','k','d','f','g','h','n'], whites: ['a','i','e','o'] },
    { reds: ['l','m','j','p','r','s','t'], whites: ['a','i','e','o'] },
    { reds: ['b','k','d','f','g','h','n'], whites: ['a','i','e','o','u'] },
    { reds: ['l','m','j','p','r','s','t'], whites: ['a','i','e','o','u'] },
{ reds: ['b','k','d','f','g','h','n'], whites: ['A'] },
    { reds: ['l','m','j','p','r','s','t'], whites: ['A'] },
    { reds: ['b','k','d','f','g','h','n'], whites: ['A','I'] },
    { reds: ['l','m','j','p','r','s','t'], whites: ['A','I'] },
    { reds: ['b','k','d','f','g','h','n'], whites: ['A','I','E'] },
    { reds: ['l','m','j','p','r','s','t'], whites: ['A','I','E'] },
    { reds: ['b','k','d','f','g','h','n'], whites: ['A','I','E','O'] },
    { reds: ['l','m','j','p','r','s','t'], whites: ['A','I','E','O'] },
    { reds: ['b','k','d','f','g','h','n'], whites: ['A','I','E','O','U'] },
    { reds: ['l','m','j','p','r','s','t'], whites: ['A','I','E','O','U'] },


  ];

  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const rect = el => el.getBoundingClientRect();

  let currentSetIndex = -1;
  let queue = [];          // å‡ºé¡Œä½‡åˆ—ï¼ˆæœƒæŠŠéŒ¯é¡Œæ¨åˆ°å°¾ï¼‰
  let basePairs = [];      // åˆå§‹é †åºï¼ˆFinish é¡¯ç¤ºç”¨ï¼‰
  let qPos = -1;
  let selectedRed = null, selectedWhite = null;
  let bellLocked = true;
  const attemptsMap = new Map(); // pair -> æ¬¡æ•¸

  /* ç‰ˆé¢ */
  function layout(){
    const stage = $('#stage'), flue = $('#flue'), santa = $('#santa'), bell = $('#bell');
    const treeLeft = $('#treeLeft'), treeBehind = $('#treeBehind'), treeFront = $('#treeFront');
    const st = rect(stage);

    const flBox = rect(flue);
    flue.style.left = (st.width/2 - flBox.width/2) + 'px';
    flue.style.bottom = '0px';
    const fl = rect(flue);

    santa.style.left = (fl.right - st.left) + 'px';
    santa.style.bottom = '0px';

    const sa = rect(santa);
    const saMid = (sa.left+sa.right)/2 - st.left;
    bell.style.left = (saMid + 120) + 'px';
    bell.style.bottom = '40px';

    const tl = rect(treeLeft);
    treeLeft.style.left = Math.max(0, fl.left - st.left - tl.width) + 'px';

    const saMidX = (sa.left + sa.right)/2 - st.left;
    treeBehind.style.left = saMidX + 'px';

    const tb = rect(treeBehind);
    treeFront.style.left = (tb.left - st.left + tb.width/2) + 'px';

    if (currentSetIndex >= 0){
      buildTree1Baubles(SETS[currentSetIndex].reds);
      buildTree2Baubles(SETS[currentSetIndex].whites);
    }
    positionBalloonGroup();
  }

  /* ç´…çƒ */
  function buildTree1Baubles(letters){
    const stage = $('#stage'), tree = $('#treeLeft');
    const sRect = rect(stage), tRect = rect(tree);
    $$('.tree1-bauble').forEach(n=>n.remove());

    const w = tRect.width, h = tRect.height;
    const originX = tRect.left - sRect.left;
    const originY = tRect.top  - sRect.top;

    const spots = [
      {x: 0.5, y: 0.08},
      {x: 0.68, y: 0.25},
      {x: 0.34, y: 0.38},
      {x:  0.7, y: 0.50},
      {x:  0.2, y: 0.60},
      {x:  0.9, y: 0.70},
      {x:  0.5, y: 0.76},
    ];
    const size = Math.max(28, Math.min(w * 0.22 * 1.3, 120 * 1.3));
    const L = Math.min(letters.length, spots.length);

    for (let i=0;i<L;i++){
      const pos = spots[i];
      const wrap = document.createElement('div');
      wrap.className = 'tree1-bauble';
      wrap.style.width = size+'px';
      wrap.style.height= size+'px';
      wrap.style.left  = (originX + pos.x*w - size/2) + 'px';
      wrap.style.top   = (originY + pos.y*h - size/2) + 'px';

      const img = document.createElement('img');
      img.src = 'graphic/redbauble.png'; img.alt = 'red bauble';

      const span = document.createElement('span');
      span.className = 'baubleLetter';
      span.textContent = letters[i];
      span.style.fontSize = (size * 0.5) + 'px';

      wrap.append(img, span);
      stage.appendChild(wrap);

      wrap.addEventListener('click', ()=>{
        if (bellLocked) return;
        $$('.tree1-bauble').forEach(n=>{
          n.classList.remove('selected');
          const im=n.querySelector('img'); if(im) im.src='graphic/redbauble.png';
        });
        wrap.classList.add('selected');
        const im=wrap.querySelector('img'); if(im) im.src='graphic/redbauble_glow.png';
        selectedRed = wrap;
      });
    }
  }

  /* ç™½çƒ */
  function buildTree2Baubles(letters){
    const stage = $('#stage'), tree = $('#treeBehind');
    const sRect = rect(stage), tRect = rect(tree);
    $$('.tree2-bauble').forEach(n=>n.remove());

    const w = tRect.width, h = tRect.height;
    const originX = tRect.left - sRect.left;
    const originY = tRect.top  - sRect.top;

    const spots = [
      {x: 0.52, y: 0.18},
      {x: 0.70, y: 0.33},
      {x: 0.34, y: 0.36},
      {x: 0.75, y: 0.53},
      {x: 0.42, y: 0.59},
      {x: 0.88, y: 0.66},
      {x: 0.52, y: 0.72},
    ];
    const size = Math.max(28, Math.min(w * 0.27, 130));
    const L = Math.min(letters.length, spots.length);

    for (let i=0;i<L;i++){
      const pos = spots[i];
      const wrap = document.createElement('div');
      wrap.className = 'tree2-bauble';
      wrap.style.width = size+'px';
      wrap.style.height= size+'px';
      wrap.style.left  = (originX + pos.x*w - size/2) + 'px';
      wrap.style.top   = (originY + pos.y*h - size/2) + 'px';

      const img = document.createElement('img');
      img.src = 'graphic/whitebauble.png'; img.alt = 'white bauble';

      const span = document.createElement('span');
      span.className = 'tree2-letter';
      span.textContent = letters[i];
      span.style.fontSize = (size * 0.52) + 'px';

      wrap.append(img, span);
      stage.appendChild(wrap);

      wrap.addEventListener('click', ()=>{
        if (bellLocked) return;
        $$('.tree2-bauble').forEach(n=>{
          n.classList.remove('selected');
          const im=n.querySelector('img'); if(im) im.src='graphic/whitebauble.png';
        });
        wrap.classList.add('selected');
        const im=wrap.querySelector('img'); if(im) im.src='graphic/whitebauble_glow.png';
        selectedWhite = wrap;
      });
    }
  }

  /* Balloon group */
  function spawnBalloonGroup(){
    const stage = $('#stage');
    $('#balloonGroup')?.remove();

    const g = document.createElement('div');
    g.id = 'balloonGroup'; g.className = 'balloon-group';

    const red = document.createElement('img');
    red.id='redBalloon'; red.className='balloon'; red.src='graphic/redballoon.png';
    const yel = document.createElement('img');
    yel.id='yellowBalloon'; yel.className='balloon'; yel.src='graphic/yellowballoon.png';
    const box = document.createElement('img');
    box.id='giftBox'; box.className='gift-box'; box.src='graphic/box1.png';

    g.append(red, yel, box);
    stage.appendChild(g);

    positionBalloonGroup();
g.classList.add('enterRight','float'); // ğŸ‘ˆ æ–°é¡Œå…¥å ´æ™‚å…ˆé£„

    const pair = getCurrentPair();
    setTimeout(() => { playOnce(`audio/${pair}.mp3`); }, 1600);

    box.addEventListener('click', ()=>{
      if (bellLocked) return;
      playOnce(`audio/${pair}.mp3`);
    });

  }
  function positionBalloonGroup(){
    const g = $('#balloonGroup'); if (!g) return;
    const st = rect($('#stage'));
    const fl = rect($('#flue'));
    const gw = g.getBoundingClientRect().width || parseFloat(getComputedStyle(g).width);
    const left = (fl.left - st.left) + fl.width/2 - gw/2 - 20;  /* å¾®èª¿ -20 */
    const top  = Math.max(10, st.height * 0.10);
    g.style.left = left + 'px';
    g.style.top  = top  + 'px';
  }

  /* å·¥å…· */
  function playOnce(src){
    return new Promise((res)=>{ const a = new Audio(src); a.onended = ()=>res(); a.onerror=()=>res(); a.play().catch(()=>res()); });
  }
  function letterOf(node){
    const span = node?.querySelector('.baubleLetter, .tree2-letter');
    return span ? span.textContent.trim().toLowerCase() : '';
  }
// Fisherâ€“Yates æ´—ç‰Œ
function shuffle(a){
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// reds äº‚åºï¼›whites å…ˆã€Œæ¯å€‹è‡³å°‘ä¸€æ¬¡ã€ï¼Œå†éš¨æ©Ÿè£œæ»¿åˆ° reds.lengthï¼Œæœ€å¾Œå†æ´—ç‰Œé…å°
function makeQueue(set){
  const reds   = Array.isArray(set.reds)   ? [...set.reds]   : [];
  const whites = Array.isArray(set.whites) ? [...set.whites] : [];

  if (reds.length === 0) return [];

  shuffle(reds);
  shuffle(whites);

  // safetyï¼šå¦‚æœ whites æ„å¤–ç‚ºç©ºï¼Œå¡ä¸€å€‹ 'a'
  if (whites.length === 0) whites.push('a');

  const L = reds.length;

  // â‘  å…ˆæ‹¿åˆ°ã€Œæ¯å€‹ white å„ä¸€æ¬¡ã€ï¼ˆæœ€å¤šæ‹¿åˆ° L å€‹ï¼‰
  const mustHave = whites.slice(0, Math.min(whites.length, L));

  // â‘¡ ä¸å¤  L çš„ï¼Œç”¨ whites ä»»æŠ½è£œæ»¿
  const whSeq = [...mustHave];
  while (whSeq.length < L){
    whSeq.push( whites[Math.floor(Math.random() * whites.length)] );
  }

  // â‘¢ æ‰“æ•£ white æ¬¡åºï¼Œé¿å…æ°¸é  aeiou æ’é ­
  shuffle(whSeq);

  // â‘£ é…å°
  return reds.map((r, i) => ({ r, w: whSeq[i] }));
}
  function getCurrentPair(){ const cur = queue[qPos]; return `${cur.r}${cur.w}`; }
  function fadeBalloon(el, burstSrc, dur=25){
    return new Promise(resolve=>{
      if (!el) return resolve();
      el.src = burstSrc;
      el.classList.add('balloon-burst-fade');
      setTimeout(()=>{ el.style.display='none'; resolve(); }, 300);
    });
  }

  /* é¡Œç›®æµç¨‹ */
  function lockBell(lock){
    bellLocked = lock;
    const b = $('#bell');
    if (lock){ b.setAttribute('disabled',''); } else { b.removeAttribute('disabled'); }
  }

  function nextQuestion(){
    qPos++;
    selectedRed = selectedWhite = null;
    $$('.tree1-bauble img').forEach(im=> im.src='graphic/redbauble.png');
    $$('.tree2-bauble img').forEach(im=> im.src='graphic/whitebauble.png');
    $$('.tree1-bauble, .tree2-bauble').forEach(b=>b.classList.remove('selected'));

    if (qPos >= queue.length){ showFinish(); return; }

    // æœªåšéå°±å…ˆç½® 0ï¼ˆä¹‹å¾ŒæŒ‰ submit æœƒ +1ï¼‰
    const key = getCurrentPair();
    if (!attemptsMap.has(key)) attemptsMap.set(key, 0);

    spawnBalloonGroup();
    lockBell(false);


  }

  /* æäº¤ */
/* æäº¤ */
function submit(){
  if (bellLocked) return;

  // è¦–è¦º + é˜è²ï¼ˆ50%ï¼‰
  const bell = $('#bell');
  bell.classList.add('bell-press');
  setTimeout(()=>bell.classList.remove('bell-press'), 120);
  (()=>{ const a=new Audio('audio/bell.mp3'); a.volume=0.5; a.play(); })();

  if (qPos < 0 || !queue[qPos]) return;
  if (!selectedRed || !selectedWhite) return;

  lockBell(true);          // æŒ‰ä¸€æ¬¡å¾Œåˆ°ä¸‹ä¸€é¡Œå…ˆè§£é–
  unlockSetPicker();       // ä»»ä½•æ™‚å€™éƒ½å¯é¸ set

  const rb  = $('#redBalloon');
  const yb  = $('#yellowBalloon');
  const box = $('#giftBox');

  const pair  = getCurrentPair();  // e.g. 'ka'
  const wantR = pair[0], wantW = pair[1];
  const gotR  = letterOf(selectedRed);
  const gotW  = letterOf(selectedWhite);

  // è¨˜ã€Œç­”å’—å¹¾æ¬¡å…ˆå•±ã€
  attemptsMap.set(pair, (attemptsMap.get(pair) || 0) + 1);

  const redOK   = (gotR === wantR);
  const whiteOK = (gotW === wantW);

  const pop = ()=>{ try{ new Audio('audio/pop.mp3').play(); }catch(e){} };

  if (redOK && whiteOK){
    // âœ… å…¨ä¸­ï¼šåœé£„ â†’ å…©å€‹æ°£çƒæ¼¸éš± â†’ 0.4s â†’ gift è½ç›’ï¼ˆ2sï¼‰â†’ 0.5s å¾Œ Happy + ä¸‹ä¸€é¡Œ
    pop();

    // åœæ•´çµ„é£„æµ®ï¼ˆåŒ…æ‹¬ giftï¼‰
    const group = $('#balloonGroup');
    group?.classList.remove('float');

    Promise.all([
      fadeBalloon(rb, 'graphic/redballoonb.png', 250),
      fadeBalloon(yb, 'graphic/yellowballoonb.png', 250)
    ]).then(()=>{
      setTimeout(()=>{                      // ç­‰æ°£çƒæ”¶ä¸€æ”¶
        if (box){
          box.style.display = '';
          // æ¸…ä»»ä½•å‚¾æ–œï¼èˆŠå‹•ç•«
          box.classList.remove('box-tilt-drop','box-tilt-neg-drop');
          box.style.animation = 'none';
          void box.offsetWidth;             // å¼·åˆ¶ reflow
          // ç›´æ¥ç”¨ inline animation é–‹å§‹ä¸‹å¢œï¼ˆæœ€ç©©é™£ï¼‰
          box.style.animation = 'boxFall 2s cubic-bezier(.2,.8,.2,1) forwards';

          // æ‰ 0.5s â†’ Happyï¼ŒåŒæ­¥å‡ºä¸‹ä¸€é¡Œ
          setTimeout(()=>{
            swapSanta(SANTA_HAPPY, 500);
            nextQuestion();
          }, 500);

          // å‹•ç•«å®Œæˆå…ˆéš±è—ç›’ï¼Œä¸¦æ¸…å› animation
          box.addEventListener('animationend', ()=>{
            box.style.display = 'none';
            box.style.animation = '';
          }, { once:true });
        }else{
          // ç†è«–ä¸Šä¸æœƒç„¡ç›’ï¼Œä½†ä¿éšª
          setTimeout(()=> swapSanta(SANTA_HAPPY, 500), 500);
          setTimeout(nextQuestion, 100);
        }
      }, 400);
    });

  } else {
    // âŒ å””ä¿‚å…¨ä¸­ï¼šé¡Œç›®æ’åˆ°éšŠå°¾ï¼Œç…§èˆŠé£›èµ°ï¼ˆä¸åœæ­¢é£„æµ®ï¼‰
    queue.push(queue[qPos]);

    // æ¸…å‚¾æ–œ classï¼ˆé¿å…æ®˜ç•™è§’åº¦ï¼‰
    if (box) box.classList.remove('box-drop','box-tilt-drop','box-tilt-neg-drop');

    // ç›´æ¥é£›èµ°ï¼›é£› 0.7s æœƒè§¸ç™¼ sadï¼ˆflyOutToLeft å…§è™•ç†ï¼‰
    flyOutToLeft(null, true);
  }
}
 

  function flyOutToLeft(after, makeSad){
    const g = $('#balloonGroup'); if (!g){ if(after) after(); return; }
    g.classList.remove('enterRight');
g.classList.add('leaver'); 
    g.classList.add('leaveLeft');
    if (makeSad){
     setTimeout(() => {
  swapSanta(SANTA_SAD, 1200);
  // âœ… ç«‹åˆ»å‡ºä¸‹ä¸€é¡Œï¼ˆèˆŠçµ„ç¹¼çºŒé£›èµ°ï¼Œæˆ‘å“‹åªä¿‚ææ—©å‡ºæ–°é¡Œï¼‰
  nextQuestion();
}, 700);
    }
    g.addEventListener('animationend', ()=>{ g.remove(); if (after) after(); }, {once:true});
  }

  function swapSanta(to, ms=1200){
    const s = $('#santa'); s.src = to; setTimeout(()=>{ s.src = SANTA_NORM; }, ms);
  }

  /* Finishï¼šåˆ—å‡ºæ‰€æœ‰é¡Œç›®ï¼ˆå¹¾å¤šæ¬¡å…ˆå•±ï¼‰ */
  function showFinish(){
    const lines = basePairs.map(p => `${p}   x   ${attemptsMap.get(p) ? attemptsMap.get(p) : 1}`);
    $('#finishList').textContent = lines.join('\n');
    $('#finishPanel').style.display = 'flex';
  lockBell(true);
unlockSetPicker();

}

  /* äº‹ä»¶ */
  $('#bell').addEventListener('click', submit);
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') submit(); });

  $('#setGoBtn').addEventListener('click', ()=>{
    const val = $('#setPickerSelect').value;
    if (val === '') return;

    currentSetIndex = parseInt(val, 10);
    // reset
    attemptsMap.clear();
    $('#finishPanel').style.display = 'none';
    qPos = -1;

    // ç•« baubles
    buildTree1Baubles(SETS[currentSetIndex].reds);
    buildTree2Baubles(SETS[currentSetIndex].whites);

    // èµ·é¡Œï¼ˆå»ºç«‹ queue + basePairsï¼‰
    queue = makeQueue(SETS[currentSetIndex]);
    basePairs = queue.map(q => `${q.r}${q.w}`);

    nextQuestion();
  });

// ğŸŸ¢ æ°¸é ç¢ºä¿é¸å–®å¯ä»¥ç”¨
function unlockSetPicker() {
  const picker = document.querySelector('#setPicker select');
  const btn = document.querySelector('#setGoBtn');
  if (picker) picker.removeAttribute('disabled');
  if (btn) btn.removeAttribute('disabled');
}

  /* é›ªèŠ± & åˆå§‹ */
  function whenImagesReady(images, cb){
    let left = images.length; if (!left) return cb();
    images.forEach(img=>{
      if (img.complete) { if(--left===0) cb(); }
      else {
        img.addEventListener('load', ()=>{ if(--left===0) cb(); });
        img.addEventListener('error',()=>{ if(--left===0) cb(); });
      }
    });
  }
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function rand(min,max){ return Math.random()*(max-min)+min; }
  function createSnowflake(stage){
    const wrap=document.createElement('div'); wrap.className='snowWrap';
    const flake=document.createElement('img'); flake.src='graphic/snow.png'; flake.alt='snow'; flake.className='snow';
    const stR=rect(stage); const sizeVw=rand(0.8,2.5); flake.style.width=sizeVw+'vw';
    const leftPx=rand(0, Math.max(0, stR.width - (stR.width*sizeVw/100))); wrap.style.left=leftPx+'px';
    const duration=rand(6,12), delay=rand(0,0.8); flake.style.animation=`snow-fall ${duration}s linear ${delay}s forwards`;
    const amp=rand(10,40), sway=rand(5,11); wrap.style.setProperty('--amp', amp+'px'); wrap.style.animation=`snow-sway ${sway}s ease-in-out ${Math.random()}s infinite alternate`;
    flake.style.transform=`rotate(${rand(-25,25)}deg)`; flake.addEventListener('animationend', ()=>wrap.remove());
    wrap.appendChild(flake); stage.appendChild(wrap); return wrap;
  }
  function spawnSnowBatch(){ const stage=$('#stage'); const count=randInt(3,7); for(let i=0;i<count;i++) createSnowflake(stage); }
  function startSnow(){ spawnSnowBatch(); setInterval(spawnSnowBatch, randInt(800,1600)); }

  const imgs = Array.from(document.querySelectorAll('img.sprite'));
  whenImagesReady(imgs, ()=>{
    layout();
    window.addEventListener('resize', layout);
    window.addEventListener('orientationchange', layout);
    if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) startSnow();
    lockBell(true); // æœªé–‹å§‹å‰ä¸å¯æŒ‰
unlockSetPicker();

  });
</script>
</body>
</html>

