<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Santa Flue – Multi Sets (fixed stage)</title>
<style>
:root{
  --game-w: 1250px;   /* 固定畫布寬 */
  --game-h: 750px;    /* 固定畫布高 */
}

/* ---- 全局 ---- */
html, body { height:100%; margin:0; }
body{ background:#bfe4f9; overflow:hidden; }

/* 外層：把整個遊戲盒置頂置中並可縮放（只縮這一層） */
.stage-outer{
  width: 100vw;
  height: 100svh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  overflow:hidden;
}

/* 畫布（固定尺寸），所有定位皆以此為基準；只對它做 scale() */
.container{
  position:relative;
  width: var(--game-w);
  height: var(--game-h);
  transform-origin: top center;
  transform: scale(1);
  background:#bfe4f9;
  overflow:visible;
}

/* 選單（放在畫布上方置中） */
#setPicker{
  position:absolute;
  top:8px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(255,255,255,.9);
  border-radius:10px;
  padding:6px 10px;
  display:flex; gap:10px; align-items:center;
  box-shadow:0 2px 8px rgba(0,0,0,.18);
  z-index:10000;
  font-size:14px;
}
#setPicker select{
  padding:6px 10px;
  border:2px solid #2b2b2b;
  border-radius:10px;
  background:#fff;
}
#setGoBtn{
  background:#c8102e; color:#fff; border:none;
  width:38px; height:38px; border-radius:999px; cursor:pointer;
  font-weight:700;
}

/* ---- 舞台角色（固定設計座標，px） ---- */
.sprite{ position:absolute; user-select:none; -webkit-user-drag:none; pointer-events:none; }

#treeLeft, #treeRight, #santa, #flue, #bell { position:absolute; }
#flue, #santa { transform-origin: bottom center; }

#treeLeft{
  height: 620px;            /* 真正生效的高度在 layoutOnce 仍會再設定一次保險 */
  left: 70px;
  top: 90px;
  z-index: 3;
}
#treeRight{
  height: 620px;
  right: 70px;              /* 用 right 固定，避免寬度變化導致 left 計算誤差 */
  top: 90px;
  z-index: 3;
}
#flue{
  width: 420px;             /* 會被 layoutOnce 調整為 70% 尺寸 */
  left: 50%; transform: translateX(-50%);
  top: 520px;
  z-index: 20;
}
#santa{
  height: 460px;            /* 會被 layoutOnce 調整為 70% 尺寸並靠 flue 右邊 */
  z-index: 4;
}
#bell{
  height: 140px;
  transform: rotate(-28deg);
  z-index: 5;
  pointer-events: auto;     /* 讓鈴鐺可點擊 */
  transition: transform .15s ease, filter .2s ease;
}
#bell:hover{ transform:rotate(-20deg) scale(1.06); filter:brightness(1.1); }

/* 放 baubles 的覆蓋層，座標和樹完全重疊 */
.tree-overlay{
  position:absolute;
  left:0; top:0; width:100%; height:100%;
  pointer-events:auto;  /* 要讓裡面的 bauble 能點擊 */
  z-index:4;            /* 在樹上層 */
}

/* ---- 雪花（可保留） ---- */
.snowWrap{ position:absolute; top:-10vh; pointer-events:none; z-index:6; will-change:transform; }
.snow{ position:relative; opacity:.95; will-change:transform,opacity; display:block; }
@keyframes snow-fall{ to{ transform:translateY(110vh) rotate(360deg); opacity:.9; } }
@keyframes snow-sway{ 0%{transform:translateX(calc(var(--amp)*-1));} 50%{transform:translateX(var(--amp));} 100%{transform:translateX(calc(var(--amp)*-1));} }

/* ---- 樹上飾物 ---- */
.tree1-bauble, .tree2-bauble{
  position:absolute; z-index:4; aspect-ratio:1/1; cursor:pointer; transform:scale(1.5);
  transition:transform .18s ease;
}
.tree1-bauble:hover, .tree2-bauble:hover{ transform:scale(1.6); }
.tree1-bauble img, .tree2-bauble img{ width:100%; height:100%; object-fit:contain; display:block; }
.baubleLetter, .tree2-letter{
  position:absolute; left:50%; bottom:12%; transform:translateX(-50%);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang HK";
  text-shadow:0 1px 2px rgba(0,0,0,.35);
}
.baubleLetter{ color:#fff; font-weight:500; }
.tree2-letter{ color:#d01010; font-weight:700; }
.tree1-bauble.selected img{ content:url('graphic/redbauble_glow.png'); }
.tree2-bauble.selected img{ content:url('graphic/whitebauble_glow.png'); }

/* ---- 氣球 & 禮物（舞台水平置中） ---- */
.balloon-group{
  position:absolute; z-index:7;
  width:220px; height:220px;
  left:50%; transform:translateX(-50%);
  top:95px;
  pointer-events:none;
}
.balloon{ position:absolute; width:60%; height:auto; }
#redBalloon{ left:20%; top:0%; z-index:1; }
#yellowBalloon{ left:50%; top:10%; z-index:2; }
#giftBox{ pointer-events:auto; cursor:pointer; position:absolute; width:58%; left:33%; top:90%; z-index:3; transition:transform .25s ease; }

@keyframes bob{ 0%{transform:translateY(0)} 50%{transform:translateY(-8px)} 100%{transform:translateY(0)} }
.balloon-group.float #redBalloon,
.balloon-group.float #yellowBalloon,
.balloon-group.float #giftBox{ animation:bob 2.6s ease-in-out infinite; }

#balloonGroup.enterRight{ animation: groupInRight 1.6s ease-out forwards; }
#balloonGroup.leaveLeft{  animation: groupOutLeft 2s ease-out forwards; }
@keyframes groupInRight{ from{ transform:translateX(calc(-50% + 60vw)); } to{ transform:translateX(-50%);} }
@keyframes groupOutLeft{  from{ transform:translateX(-50%);} to{ transform:translateX(calc(-50% - 110vw));} }

/* 泡泡爆開 → 禮物下墜 */
.balloon-burst-fade{ animation: burstFade .25s linear forwards; }
@keyframes burstFade{ from{opacity:1} to{opacity:0} }
@keyframes boxFall {
  0%   { transform: translateY(0); opacity:1; }
  85%  { transform: translateY(75vh); opacity:1; }
  100% { transform: translateY(80vh); opacity:0; }
}

/* ---- Finish 面板 ---- */
#finishPanel{
  position:absolute; inset:0; display:none; align-items:center; justify-content:center;
  background:transparent; z-index:9000; pointer-events:none;
}
#finishCard{
  background:transparent; border-radius:12px; padding:16px 18px;
  width:clamp(260px,15vw,380px); max-width:90%;
  text-align:center; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
#finishCard h2{ margin:.2em 0 .3em; font-size:30px; color:#8d0f0f; }
#finishList{ font-size:20px; line-height:1.6; white-space:pre; margin-bottom:10px; }

/* ---- 旋轉提示（一次） ---- */
#rotateHint{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  z-index:4000; pointer-events:none;
}
#rotateHint .msg{
  width:90vw; text-align:center; color:#fff; font-weight:900; line-height:1.15;
  font-size:clamp(22px, 9vw, 56px);
  text-shadow:0 0 8px rgba(0,0,0,.75), 0 0 18px rgba(0,0,0,.55);
  animation: rotateHintFlash 1.1s ease-in-out infinite;
}
@keyframes rotateHintFlash{ 0%,100%{opacity:.95; transform:scale(1)} 50%{opacity:.7; transform:scale(1.02)} }
</style>
</head>
<body>
  <div class="stage-outer">
    <div class="container" id="canvas">
      <!-- Set 選單 -->
      <div id="setPicker">
        <select id="setPickerSelect">
          <option value="">-----</option>
          <option value="0">Set 1</option>
          <option value="1">Set 2</option>
          <option value="2">Set 3</option>
          <option value="3">Set 4</option>
          <option value="4">Set 5</option>
          <option value="5">Set 6</option>
          <option value="6">Set 7</option>
          <option value="7">Set 8AA</option>
          <option value="8">Set 9</option>
          <option value="9">Set 10</option>
        </select>
        <button id="setGoBtn">Go</button>
      </div>

      <!-- 舞台精靈 -->
      <img id="flue" class="sprite" src="graphic/flue.png" alt="flue" />
      <img id="treeLeft" class="sprite" src="graphic/tree.png" alt="tree left" />
      <img id="treeRight" class="sprite" src="graphic/tree.png" alt="tree right" />
      <img id="santa" class="sprite" src="graphic/santa.png" alt="santa" />
      <img id="bell"  class="sprite" src="graphic/bell.png"  alt="bell"  />

      <!-- Finish -->
      <div id="finishPanel"><div id="finishCard">
        <h2>Finish!</h2><div id="finishList"></div>
      </div></div>
    </div>
  </div>

  <div id="rotateHint"><div class="msg">please turn your phone sideways to play</div></div>

<script>
/* ============ 常量與資料 ============ */
const SANTA_HAPPY = 'graphic/santa_happy.png';
const SANTA_SAD   = 'graphic/santa_sad.png';
const SANTA_NORM  = 'graphic/santa.png';

/* SETS */
const SETS = [
  { reds: ['b','k','d','f','g','h','n'], whites: ['a'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['a'] },
  { reds: ['b','k','d','f','g','h','n'], whites: ['a','i'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['a','i'] },
  { reds: ['b','k','d','f','g','h','n'], whites: ['a','i','e'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['a','i','e'] },
  { reds: ['b','k','d','f','g','h','n'], whites: ['a','i','e','o'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['a','i','e','o'] },
  { reds: ['b','k','d','f','g','h','n'], whites: ['a','i','e','o','u'] },
  { reds: ['l','m','j','p','r','s','t'], whites: ['a','i','e','o','u'] }
];

/* 讀 CSS 變數，避免數值不一致 */
function cssNumber(varName){
  const v = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  return parseInt(v.replace('px',''),10);
}
const GAME_W = cssNumber('--game-w');
const GAME_H = cssNumber('--game-h');
/* 底線：畫布高度的 88% 左右（可微調） */
const BASELINE_Y = Math.round(GAME_H * 0.88);

/* ============ 工具 ============ */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function fitStage(){
  const vw = window.innerWidth, vh = window.innerHeight;
  const scale = Math.min(1, vw / GAME_W, vh / GAME_H);
  const stage = $('.container');
  if (stage) stage.style.transform = `scale(${scale})`;
}

/* 一次旋轉提示（手機直向） */
const ROTATE_HINT_KEY = 'rotateHintShown_encode_v1';
function isMobilePortrait(){
  const isMobileUA = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
  const isPortrait = window.matchMedia('(orientation: portrait)').matches;
  return isMobileUA && isPortrait && window.innerWidth <= 820;
}
function showRotateHintOnce(){
  if (sessionStorage.getItem(ROTATE_HINT_KEY)) return;
  if (!isMobilePortrait()) return;
  const el = $('#rotateHint'); if (!el) return;
  el.style.display = 'flex';
  sessionStorage.setItem(ROTATE_HINT_KEY,'1');
  setTimeout(()=>{ el.style.display='none'; }, 4000);
}

/* 音效 */
function playOnce(src){
  return new Promise(res=>{
    const a = new Audio(src);
    a.onended = ()=>res(); a.onerror=()=>res();
    a.play().catch(()=>res());
  });
}

/* 隨機/洗牌 */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function makeQueue(set){
  const reds=[...(set.reds||[])], whites=[...(set.whites||[])];
  shuffle(reds); shuffle(whites); if(!whites.length) whites.push('a');
  const L=reds.length, must=whites.slice(0, Math.min(whites.length, L));
  const seq=[...must]; while(seq.length<L) seq.push( whites[Math.floor(Math.random()*whites.length)] );
  shuffle(seq);
  return reds.map((r,i)=>({r, w:seq[i]}));
}

/* ============ 遊戲狀態 ============ */
let currentSetIndex=-1, queue=[], basePairs=[], qPos=-1;
let selectedRed=null, selectedWhite=null, bellLocked=true;
const attemptsMap = new Map();

/* bauble spots（用百分比） */
const SPOTS_LEFT  = [
  {x:.50, y:.08}, {x:.68, y:.25}, {x:.34, y:.38},
  {x:.70, y:.50}, {x:.20, y:.60}, {x:.90, y:.70}, {x:.50, y:.76}
];
const SPOTS_RIGHT = [
  {x:.52, y:.18}, {x:.70, y:.33}, {x:.34, y:.36},
  {x:.75, y:.53}, {x:.42, y:.59}, {x:.88, y:.66}, {x:.52, y:.72}
];

/* ---- 只排一次：固定所有位置（之後只 scale） ---- */
function layoutOnce(){
  const flue  = document.getElementById('flue');
  const santa = document.getElementById('santa');
  const treeL = document.getElementById('treeLeft');
  const treeR = document.getElementById('treeRight');
  const bell  = document.getElementById('bell');

  /* 樹：固定高度、左右位置（right 固定最穩） */
  const TREE_H = Math.round(GAME_H * 0.83); // 約 620/750
  treeL.style.height = TREE_H + 'px';
  treeR.style.height = TREE_H + 'px';
  treeL.style.left   = '70px';
  treeL.style.top    = (BASELINE_Y - TREE_H) + 'px';
  treeR.style.right  = '70px';
  treeR.style.left   = '';                      // 用 right 固定
  treeR.style.top    = (BASELINE_Y - TREE_H) + 'px';

  /* flue / santa 變 0.7 倍（設定寬/高，非 transform），並在底線 */
  const SCALE_FS = 0.7;

  // flue 置中
  const flueW = Math.round(flue.naturalWidth  * SCALE_FS);
  const flueH = Math.round(flue.naturalHeight * SCALE_FS);
  flue.style.width = flueW + 'px';
  flue.style.height = 'auto';
  flue.style.left = Math.round(GAME_W/2 - flueW/2) + 'px';
  flue.style.top  = (BASELINE_Y - flueH) + 'px';

  // santa 在 flue 右邊，與 flue 底齊
  const sH = Math.round(santa.naturalHeight * SCALE_FS);
  const sW = Math.round(santa.naturalWidth  * SCALE_FS);
  santa.style.height = sH + 'px';
  santa.style.width  = 'auto';
  const GAP = 80;
  santa.style.left = (flue.offsetLeft + flueW + GAP) + 'px';
  santa.style.top  = (BASELINE_Y - sH) + 'px';

  // bell 在 santa 右下
  const bellH = Math.round(bell.naturalHeight * SCALE_FS);
  bell.style.height = bellH + 'px';
  bell.style.width  = 'auto';
  bell.style.left = (santa.offsetLeft + sW - Math.round(bellH*0.9)) + 'px';
  bell.style.top  = (BASELINE_Y - bellH + 35) + 'px';

  // 氣球基於 flue（再保險定位一次）
  positionBalloonByFlue();
}

/* 以 flue 定氣球位置（用 offset，不受 scale 影響） */
function positionBalloonByFlue(){
  const g = document.getElementById('balloonGroup');
  const fl = document.getElementById('flue');
  if (!g || !fl) return;
  const gw = g.offsetWidth || parseFloat(getComputedStyle(g).width);
  g.style.left = (fl.offsetLeft + fl.offsetWidth/2 - gw/2) + 'px';
  g.style.top  = (fl.offsetTop - gw*0.7) + 'px';
}

/* ---- baubles 黏在樹上（overlay 百分比定位） ---- */
function ensureTreeOverlay(treeEl, id){
  let ov = document.getElementById(id);
  if (!ov){
    ov = document.createElement('div');
    ov.id = id;
    ov.className = 'tree-overlay';
    treeEl.parentElement.appendChild(ov);
  }
  ov.style.left   = treeEl.offsetLeft + 'px';
  ov.style.top    = treeEl.offsetTop  + 'px';
  ov.style.width  = treeEl.clientWidth  + 'px';
  ov.style.height = treeEl.clientHeight + 'px';
  return ov;
}
function buildTreeBaubles(treeSelector, letters, spots, isRight){
  const tree = document.querySelector(treeSelector);
  const overlay = ensureTreeOverlay(tree, isRight ? 'ovRight' : 'ovLeft');

  overlay.querySelectorAll('.tree1-bauble, .tree2-bauble').forEach(n=>n.remove());

  const w = overlay.clientWidth;
  const size = Math.max(28, Math.min(w * 0.22 * 1.3, 120 * 1.3)); // 白紅同規則
  const L = Math.min(letters.length, spots.length);

  for (let i=0;i<L;i++){
    const pos = spots[i];
    const wrap = document.createElement('div');
    wrap.className = isRight ? 'tree2-bauble' : 'tree1-bauble';
    wrap.style.position = 'absolute';
    wrap.style.width  = size+'px';
    wrap.style.height = size+'px';
    wrap.style.left = `calc(${pos.x*100}% - ${size/2}px)`;
    wrap.style.top  = `calc(${pos.y*100}% - ${size/2}px)`;

    const img = document.createElement('img');
    img.src = isRight ? 'graphic/whitebauble.png' : 'graphic/redbauble.png';

    const span = document.createElement('span');
    span.className = isRight ? 'tree2-letter' : 'baubleLetter';
    span.textContent = letters[i];
    span.style.fontSize = (size * 0.52) + 'px';
    span.style.position='absolute';
    span.style.left='50%'; span.style.bottom='12%';
    span.style.transform='translateX(-50%)';

    wrap.append(img, span);
    overlay.appendChild(wrap);

    // 點選
    wrap.addEventListener('click', ()=>{
      if (bellLocked) return;
      overlay.querySelectorAll(isRight?'.tree2-bauble':'.tree1-bauble').forEach(n=>{
        n.classList.remove('selected');
        const im=n.querySelector('img');
        if (im) im.src = isRight ? 'graphic/whitebauble.png' : 'graphic/redbauble.png';
      });
      wrap.classList.add('selected');
      const im = wrap.querySelector('img');
      if (im) im.src = isRight ? 'graphic/whitebauble_glow.png' : 'graphic/redbauble_glow.png';
      if (isRight) selectedWhite = wrap; else selectedRed = wrap;
    });
  }
}
function letterOf(node){
  const span = node?.querySelector('.baubleLetter, .tree2-letter');
  return span ? span.textContent.trim().toLowerCase() : '';
}

/* ---- 氣球 ---- */
function spawnBalloonGroup(){
  $('#balloonGroup')?.remove();
  const stage = $('.container');
  const g = document.createElement('div');
  g.id='balloonGroup'; g.className='balloon-group enterRight float';

  const red = document.createElement('img'); red.id='redBalloon'; red.className='balloon'; red.src='graphic/redballoon.png';
  const yel = document.createElement('img'); yel.id='yellowBalloon'; yel.className='balloon'; yel.src='graphic/yellowballoon.png';
  const box = document.createElement('img'); box.id='giftBox'; box.className='gift-box'; box.src='graphic/box1.png';
  g.append(red,yel,box);
  stage.appendChild(g);

  positionBalloonByFlue();

  const pair = getCurrentPair();
  setTimeout(()=>{ playOnce(`audio/${pair}.mp3`); }, 1600);

  box.addEventListener('click', ()=>{ if(!bellLocked) playOnce(`audio/${pair}.mp3`); });
}

function getCurrentPair(){ const cur = queue[qPos]; return `${cur.r}${cur.w}`; }
function fadeBalloon(el, burstSrc){ return new Promise(res=>{ if(!el) return res(); el.src=burstSrc; el.classList.add('balloon-burst-fade'); setTimeout(()=>{ el.style.display='none'; res(); }, 300); }); }

/* 鐘鎖定 */
function lockBell(lock){
  bellLocked = lock;
  const b = $('#bell');
  if (lock) b.setAttribute('disabled',''); else b.removeAttribute('disabled');
}

/* 題目流程 */
function nextQuestion(){
  qPos++;
  selectedRed = selectedWhite = null;
  $$('.tree1-bauble img').forEach(im=> im.src='graphic/redbauble.png');
  $$('.tree2-bauble img').forEach(im=> im.src='graphic/whitebauble.png');
  $$('.tree1-bauble, .tree2-bauble').forEach(b=>b.classList.remove('selected'));

  if (qPos >= queue.length){ showFinish(); return; }

  const key = getCurrentPair();
  if (!attemptsMap.has(key)) attemptsMap.set(key, 0);

  spawnBalloonGroup();
  lockBell(false);
}

/* 提交 */
function submit(){
  if (bellLocked) return;

  // 鐘聲 + 視覺
  const bell = $('#bell');
  bell.style.transform = 'rotate(-20deg) scale(1.05)';
  setTimeout(()=>bell.style.transform='rotate(-28deg) scale(1)', 120);
  (new Audio('audio/bell.mp3')).play().catch(()=>{});

  if (qPos < 0 || !queue[qPos]) return;
  if (!selectedRed || !selectedWhite) return;

  lockBell(true);
  unlockSetPicker();

  const rb  = $('#redBalloon');
  const yb  = $('#yellowBalloon');
  const box = $('#giftBox');

  const pair  = getCurrentPair();
  const wantR = pair[0], wantW = pair[1];
  const gotR  = letterOf(selectedRed);
  const gotW  = letterOf(selectedWhite);

  attemptsMap.set(pair, (attemptsMap.get(pair) || 0) + 1);

  const redOK   = (gotR === wantR);
  const whiteOK = (gotW === wantW);

  const pop = ()=>{ try{ new Audio('audio/pop.mp3').play(); }catch(e){} };

  if (redOK && whiteOK){
    pop();
    const group = $('#balloonGroup');
    group?.classList.remove('float');

    Promise.all([
      fadeBalloon(rb, 'graphic/redballoonb.png'),
      fadeBalloon(yb, 'graphic/yellowballoonb.png')
    ]).then(()=>{
      setTimeout(()=>{
        if (box){
          box.style.display='';
          box.style.animation='none'; void box.offsetWidth;
          box.style.animation='boxFall 2s cubic-bezier(.2,.8,.2,1) forwards';
          setTimeout(()=>{ swapSanta(SANTA_HAPPY, 500); nextQuestion(); }, 500);
          box.addEventListener('animationend', ()=>{ box.style.display='none'; box.style.animation=''; }, {once:true});
        }else{
          setTimeout(()=> swapSanta(SANTA_HAPPY, 500), 500);
          setTimeout(nextQuestion, 100);
        }
      }, 400);
    });

  } else {
    queue.push(queue[qPos]); // 排到最後
    flyOutToLeft(null, true);
  }
}

function flyOutToLeft(after, makeSad){
  const g = $('#balloonGroup'); if(!g){ after&&after(); return; }
  g.classList.remove('enterRight');
  g.classList.add('leaveLeft');
  if (makeSad){
    setTimeout(()=>{ swapSanta(SANTA_SAD, 1200); nextQuestion(); }, 700);
  }
  g.addEventListener('animationend', ()=>{ g.remove(); after&&after(); }, {once:true});
}

function swapSanta(to, ms=1200){
  const s = $('#santa'); s.src = to; setTimeout(()=>{ s.src = SANTA_NORM; }, ms);
}

function showFinish(){
  const lines = basePairs.map(p => `${p}   x   ${attemptsMap.get(p) ? attemptsMap.get(p) : 1}`);
  $('#finishList').textContent = lines.join('\n');
  $('#finishPanel').style.display = 'flex';
  lockBell(true);
  unlockSetPicker();
}

/* Set 選單 */
function unlockSetPicker(){
  const picker = document.querySelector('#setPicker select');
  const btn = document.querySelector('#setGoBtn');
  picker && picker.removeAttribute('disabled');
  btn && btn.removeAttribute('disabled');
}

$('#bell').addEventListener('click', submit);
window.addEventListener('keydown', e=>{ if(e.key==='Enter') submit(); });

$('#setGoBtn').addEventListener('click', ()=>{
  const val = $('#setPickerSelect').value;
  if (val === '') return;

  currentSetIndex = parseInt(val, 10);
  attemptsMap.clear();
  $('#finishPanel').style.display = 'none';
  qPos = -1;

  /* 先保險更新一次 overlay 尺寸與位置，再擺 baubles */
  const set = SETS[currentSetIndex];
  buildTreeBaubles('#treeLeft',  set.reds,   SPOTS_LEFT,  false);
  buildTreeBaubles('#treeRight', set.whites, SPOTS_RIGHT, true);

  queue = makeQueue(set);
  basePairs = queue.map(q => `${q.r}${q.w}`);
  nextQuestion();
});

/* ---- 雪花（可保留原本的隨機飄） ---- */
function whenImagesReady(images, cb){
  let left = images.length; if (!left) return cb();
  images.forEach(img=>{
    if (img.complete) { if(--left===0) cb(); }
    else {
      img.addEventListener('load', ()=>{ if(--left===0) cb(); });
      img.addEventListener('error',()=>{ if(--left===0) cb(); });
    }
  });
}
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function rand(min,max){ return Math.random()*(max-min)+min; }
function createSnowflake(stage){
  const wrap=document.createElement('div'); wrap.className='snowWrap';
  const flake=document.createElement('img'); flake.src='graphic/snow.png'; flake.alt='snow'; flake.className='snow';
  const stW=stage.clientWidth;
  const sizeVw=rand(0.8,2.2); flake.style.width=sizeVw+'vw';
  const leftPx=rand(0, Math.max(0, stW - (stW*sizeVw/100))); wrap.style.left=leftPx+'px';
  const duration=rand(6,12), delay=rand(0,0.8); flake.style.animation=`snow-fall ${duration}s linear ${delay}s forwards`;
  const amp=rand(10,40), sway=rand(5,11); wrap.style.setProperty('--amp', amp+'px'); wrap.style.animation=`snow-sway ${sway}s ease-in-out ${Math.random()}s infinite alternate`;
  flake.style.transform=`rotate(${rand(-25,25)}deg)`;
  flake.addEventListener('animationend', ()=>wrap.remove());
  wrap.appendChild(flake); stage.appendChild(wrap); return wrap;
}
function spawnSnowBatch(){ const stage=$('.container'); const count=randInt(3,7); for(let i=0;i<count;i++) createSnowflake(stage); }
function startSnow(){ spawnSnowBatch(); setInterval(spawnSnowBatch, randInt(800,1600)); }

/* ---- 啟動 ---- */
window.addEventListener('load', fitStage);
window.addEventListener('resize', fitStage);
window.addEventListener('orientationchange', fitStage);
window.addEventListener('load', showRotateHintOnce);

const imgs = Array.from(document.querySelectorAll('img.sprite'));
whenImagesReady(imgs, ()=>{
  layoutOnce();            // ★ 只排一次固定位置
  fitStage();              // 然後視窗只整體縮放
  startSnow();             // 可選
  lockBell(true);
  unlockSetPicker();
});
</script>
</body>
</html>
